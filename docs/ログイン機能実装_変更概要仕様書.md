# ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½å®Ÿè£… å¤‰æ›´æ¦‚è¦ä»•æ§˜æ›¸

**ä½œæˆæ—¥**: 2025-09-02  
**ä½œæˆè€…**: ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒãƒ¼ãƒ   
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**å„ªå…ˆåº¦**: ğŸ”´ é«˜

## æ¦‚è¦

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ç‰©æµãƒˆãƒ©ãƒ–ãƒ«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®å¤‰æ›´æ¦‚è¦ã‚’å®šç¾©ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã€ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã€ãƒ­ãƒ¼ãƒ«åˆ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤ºæ©Ÿèƒ½ã‚’å«ã¿ã¾ã™ã€‚

## èƒŒæ™¯ãƒ»ç›®çš„

### ç¾çŠ¶ã®å•é¡Œ
- ç¾åœ¨ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯èªè¨¼ãƒ»èªå¯æ©Ÿèƒ½ãŒä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹
- ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç·¨é›†æ™‚ã«403 Forbiddenã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ãŒæœªå®Ÿè£…ã®çŠ¶æ…‹

### å®Ÿè£…ã®ç›®çš„
- ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰
- ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã«ã‚ˆã‚‹é©åˆ‡ãªæ¨©é™ç®¡ç†
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«åˆ¥ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤ºã«ã‚ˆã‚‹æ¥­å‹™åŠ¹ç‡åŒ–

## æ©Ÿèƒ½è¦ä»¶

### 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ©Ÿèƒ½

#### 1.1 ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½
- **å…¥åŠ›é …ç›®**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
- **èªè¨¼æ–¹å¼**: JWTï¼ˆJSON Web Tokenï¼‰ãƒ™ãƒ¼ã‚¹
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**: ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã—ï¼‰
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ã€ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒå¯¾ç­–

#### 1.2 ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
- **ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ**: è©²å½“RTã‚’å¤±åŠ¹ï¼ˆDBãƒ¬ã‚³ãƒ¼ãƒ‰å‰Šé™¤/Revokedï¼‰ã€ä»¥é™ATã¯çŸ­å¯¿å‘½ã§è‡ªç„¶å¤±åŠ¹
- **å†åˆ©ç”¨æ¤œçŸ¥**: RTå†åˆ©ç”¨ã‚’æ¤œå‡ºã—ãŸã‚‰è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨RTã‚’å¤±åŠ¹
- **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚¯ãƒªã‚¢

#### 1.3 ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç®¡ç†
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¦ä»¶**: æœ€å°8æ–‡å­—ã€å¤§æ–‡å­—ãƒ»å°æ–‡å­—ãƒ»æ•°å­—ãƒ»è¨˜å·ã‚’å«ã‚€
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ**: ãƒ¡ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´**: ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´æ©Ÿèƒ½

### 2. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«ç®¡ç†

#### 2.1 ãƒ­ãƒ¼ãƒ«å®šç¾©
| ãƒ­ãƒ¼ãƒ«ID | ãƒ­ãƒ¼ãƒ«å | èª¬æ˜ | æ¨©é™ãƒ¬ãƒ™ãƒ« |
|----------|----------|------|------------|
| 1 | äº‹å‹™å“¡ (Clerk) | åŸºæœ¬çš„ãªã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç®¡ç† | ä½ |
| 2 | ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç®¡ç†è€… (Incident Manager) | ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆåˆ†é¡ãƒ»ç®¡ç† | ä¸­ |
| 3 | å€‰åº«æ‹…å½“ (Warehouse Staff) | è§£æ±ºç­–æ¤œè¨ãƒ»ç™»éŒ² | ä¸­ |
| 4 | ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€… (Admin) | å…¨æ©Ÿèƒ½ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† | é«˜ |

#### 2.2 æ¨©é™ãƒãƒˆãƒªãƒƒã‚¯ã‚¹
| æ©Ÿèƒ½ | äº‹å‹™å“¡ | ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç®¡ç†è€… | å€‰åº«æ‹…å½“ | ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€… |
|------|--------|-------------------|----------|----------------|
| ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆé–²è¦§ | â—‹ | â—‹ | â—‹ | â—‹ |
| ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç™»éŒ² | â—‹ | â—‹ | â—‹ | â—‹ |
| ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç·¨é›† | â—‹ | â—‹ | â—‹ | â—‹ |
| ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå‰Šé™¤ | Ã— | Ã— | Ã— | â—‹ |
| ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆåˆ†é¡ | Ã— | â—‹ | Ã— | â—‹ |
| è§£æ±ºç­–ç™»éŒ² | Ã— | Ã— | â—‹ | â—‹ |
| åŠ¹æœæ¸¬å®š | Ã— | â—‹ | â—‹ | â—‹ |
| çµ±è¨ˆé–²è¦§ | â—‹ | â—‹ | â—‹ | â—‹ |
| ãƒã‚¹ã‚¿ç®¡ç† | Ã— | Ã— | Ã— | â—‹ |
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† | Ã— | Ã— | Ã— | â—‹ |

### 3. ãƒ­ãƒ¼ãƒ«åˆ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

#### 3.1 äº‹å‹™å“¡ (Clerk)
**ãƒ­ã‚°ã‚¤ãƒ³æ™‚è¡¨ç¤ºé …ç›®:**
- æœªè§£æ±ºã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ
- å¯¾å¿œä¸­ã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ

**ä¸»è¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:**
- æ–°è¦ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®ç™»éŒ²
- æ‹…å½“ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®ç·¨é›†ãƒ»æ›´æ–°

#### 3.2 ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç®¡ç†è€… (Incident Manager)
**ãƒ­ã‚°ã‚¤ãƒ³æ™‚è¡¨ç¤ºé …ç›®:**
- æœªè§£æ±ºã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ
- å¯¾å¿œä¸­ã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ


**ä¸»è¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:**
- ç™»éŒ²ã•ã‚ŒãŸã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®ç¨®é¡åˆ†ã‘
- ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®å„ªå…ˆåº¦è¨­å®š
- æ‹…å½“è€…ã®å‰²ã‚Šå½“ã¦

#### 3.3 å€‰åº«æ‹…å½“ (Warehouse Staff)
**ãƒ­ã‚°ã‚¤ãƒ³æ™‚è¡¨ç¤ºé …ç›®:**
- æœªè§£æ±ºã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ
- å¯¾å¿œä¸­ã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç´ã¥ãå€‰åº«ã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ
- ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç®¡ç†è€…ã«ç¨®é¡åˆ†ã‘ã•ã‚ŒãŸã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ

**ä¸»è¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:**
- è§£æ±ºç­–ã®æ¤œè¨ãƒ»ç™»éŒ²
- åŠ¹æœæ¸¬å®šã®å®Ÿæ–½
- å†ç™ºé˜²æ­¢ç­–ã®ææ¡ˆ

#### 3.4 ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€… (Admin)
**ãƒ­ã‚°ã‚¤ãƒ³æ™‚è¡¨ç¤ºé …ç›®:**
- å…¨ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã®æ¦‚è¦
- ã‚·ã‚¹ãƒ†ãƒ çµ±è¨ˆæƒ…å ±
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æƒ…å ±

**ä¸»è¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:**
- å…¨æ©Ÿèƒ½ã®åˆ©ç”¨
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ãƒ­ãƒ¼ãƒ«ç®¡ç†
- ã‚·ã‚¹ãƒ†ãƒ è¨­å®šç®¡ç†

## æŠ€è¡“ä»•æ§˜

### 1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

#### 1.1 èªè¨¼ãƒ»èªå¯ã‚·ã‚¹ãƒ†ãƒ 
- **èªè¨¼æ–¹å¼**: JWTï¼ˆJSON Web Tokenï¼‰
- **ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™**: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³15åˆ†ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³7æ—¥
- **ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹åŒ–**: TokenVersionã«ã‚ˆã‚‹ç„¡åŠ¹åŒ–ã€RTå¤±åŠ¹ã«ã‚ˆã‚‹åˆ¶å¾¡
- **æš—å·åŒ–**: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯bcryptã§ãƒãƒƒã‚·ãƒ¥åŒ–ã€RTã¯ãƒãƒƒã‚·ãƒ¥åŒ–ä¿å­˜
- **ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢**: JWTèªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã€ãƒ­ãƒ¼ãƒ«èªå¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: RTå†åˆ©ç”¨æ¤œçŸ¥ã€å…¨RTå¤±åŠ¹ã«ã‚ˆã‚‹ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢

#### 1.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ
**Usersãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ:**
```sql
ALTER TABLE Users ADD
    PasswordHash NVARCHAR(MAX) NOT NULL,
    LastLoginAt DATETIME2 NULL,
    TokenVersion INT NOT NULL DEFAULT 1; -- ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹åŒ–ç”¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
```

**Rolesãƒ†ãƒ¼ãƒ–ãƒ«æ–°è¦ä½œæˆ:**
```sql
CREATE TABLE Roles (
    Id INT PRIMARY KEY IDENTITY(1,1),
    Name NVARCHAR(50) NOT NULL UNIQUE,
    Description NVARCHAR(200) NULL,
    IsActive BIT NOT NULL DEFAULT 1,
    CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    UpdatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE()
);
```

**RefreshTokensãƒ†ãƒ¼ãƒ–ãƒ«æ–°è¦ä½œæˆ:**
```sql
CREATE TABLE RefreshTokens (
    Id BIGINT IDENTITY(1,1) PRIMARY KEY,
    UserId INT NOT NULL,
    TokenHash VARBINARY(64) NOT NULL, -- å¹³æ–‡ä¿å­˜ç¦æ­¢
    ExpiresAt DATETIME2 NOT NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    RevokedAt DATETIME2 NULL,
    ReplacedByTokenHash VARBINARY(64) NULL,
    Reason NVARCHAR(100) NULL,
    UserAgent NVARCHAR(200) NULL,
    IpAddress NVARCHAR(45) NULL,
    CONSTRAINT FK_RT_User FOREIGN KEY (UserId) REFERENCES Users(Id),
    INDEX IX_RT_User_Active (UserId, ExpiresAt) WHERE RevokedAt IS NULL
);
```

**æ—¢å­˜Roleãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ´»ç”¨:**
- `Users.Role`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’`Roles`ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤–éƒ¨ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨
- è¤‡é›‘ãªä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ä¸è¦ã§ã€ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹æˆã‚’æ¡ç”¨

#### 1.3 APIè¨­è¨ˆ
**èªè¨¼API:**
- `POST /api/auth/login` - ãƒ­ã‚°ã‚¤ãƒ³
- `POST /api/auth/logout` - ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
- `POST /api/auth/refresh` - ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
- `POST /api/auth/change-password` - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
- `POST /api/auth/forgot-password` - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚
- `POST /api/auth/reset-password` - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ

**ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†API:**
- `GET /api/users/profile` - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
- `PUT /api/users/profile` - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°
- `GET /api/users` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
- `POST /api/users` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
- `PUT /api/users/{id}` - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰
- `DELETE /api/users/{id}` - ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ï¼ˆç®¡ç†è€…ã®ã¿ï¼‰

### 2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

#### 2.1 èªè¨¼UI
- **ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢**: `/login`
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”»é¢**: `/forgot-password`
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ç”»é¢**: `/change-password`

#### 2.2 èªè¨¼çŠ¶æ…‹ç®¡ç†
- **Context API**: èªè¨¼çŠ¶æ…‹ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ç®¡ç†
- **ã‚»ã‚­ãƒ¥ã‚¢ã‚¯ãƒƒã‚­ãƒ¼**: ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¿å­˜ï¼ˆSecure, HttpOnly, SameSiteå±æ€§ä»˜ãï¼‰
- **ãƒ¡ãƒ¢ãƒªå†…ä¿å­˜**: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¿å­˜ï¼ˆãƒ¡ãƒ¢ãƒªå†…å¤‰æ•°/ã‚¹ãƒˆã‚¢ã®ã¿ï¼‰
- **CSRFä¿è­·**: CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®å®Ÿè£…ã¨æ¤œè¨¼

#### 2.3 ãƒ«ãƒ¼ãƒˆä¿è­·
- **Protected Route**: èªè¨¼ãŒå¿…è¦ãªãƒšãƒ¼ã‚¸ã®ä¿è­·
- **Role-based Route**: ãƒ­ãƒ¼ãƒ«åˆ¥ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- **ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ**: æœªèªè¨¼æ™‚ã®ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ã®èª˜å°

#### 2.4 ãƒ­ãƒ¼ãƒ«åˆ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
- **å‹•çš„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**: ãƒ­ãƒ¼ãƒ«ã«å¿œã˜ãŸè¡¨ç¤ºå†…å®¹ã®åˆ‡ã‚Šæ›¿ãˆ
- **æ¡ä»¶ä»˜ããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°**: æ¨©é™ã«å¿œã˜ãŸUIè¦ç´ ã®è¡¨ç¤ºãƒ»éè¡¨ç¤º
- **ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³**: ãƒ­ãƒ¼ãƒ«åˆ¥ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º

### 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶

#### 3.1 ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶
**ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³:**
- ã‚»ã‚­ãƒ¥ã‚¢ã‚¯ãƒƒã‚­ãƒ¼ã§ã®ä¿å­˜ï¼ˆlocalStorage/sessionStorageã¯ä½¿ç”¨ç¦æ­¢ï¼‰
- å¿…é ˆå±æ€§: `Secure`, `HttpOnly`, `SameSite=Strict`ï¼ˆã¾ãŸã¯`Lax`ï¼‰
- æœ‰åŠ¹æœŸé™: 7-30æ—¥ï¼ˆè¨­å®šå¯èƒ½ï¼‰
- è‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³: ä½¿ç”¨æ™‚ã«æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç™ºè¡Œ

**ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³:**
- ãƒ¡ãƒ¢ãƒªå†…ä¿å­˜ã®ã¿ï¼ˆlocalStorage/sessionStorageã¯ä½¿ç”¨ç¦æ­¢ï¼‰
- æœ‰åŠ¹æœŸé™: 15åˆ†-1æ™‚é–“ï¼ˆçŸ­æ™‚é–“ï¼‰
- è‡ªå‹•æ›´æ–°: ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ãŸè‡ªå‹•æ›´æ–°

#### 3.2 CSRFä¿è­·
- CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®å®Ÿè£…ã¨æ¤œè¨¼
- å…¨POST/PUT/DELETEãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã®CSRFãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
- ãƒ€ãƒ–ãƒ«ã‚µãƒ–ãƒŸãƒƒãƒˆé˜²æ­¢

#### 3.3 ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºå®šæ”»æ’ƒã®é˜²æ­¢
- ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDå†ç”Ÿæˆ
- åŒæ™‚ãƒ­ã‚°ã‚¤ãƒ³åˆ¶é™ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã®å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–

## æ—¢å­˜APIã¸ã®å½±éŸ¿ã¨å¯¾å¿œç­–

### 1. èªè¨¼ãƒ»èªå¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®è¿½åŠ 

#### 1.1 å½±éŸ¿ã‚’å—ã‘ã‚‹ç®‡æ‰€
- `Program.cs` - èªè¨¼ãƒ»èªå¯ã‚µãƒ¼ãƒ“ã‚¹ã®ç™»éŒ²
- å…¨APIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ - èªè¨¼ãƒ»èªå¯å±æ€§ã®è¿½åŠ 

#### 1.2 å…·ä½“çš„ãªå¤‰æ›´å†…å®¹
**Program.csã¸ã®è¿½åŠ :**
```csharp
// èªè¨¼ãƒ»èªå¯ã‚µãƒ¼ãƒ“ã‚¹ã®ç™»éŒ²
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options => {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = builder.Configuration["Jwt:Issuer"],
            ValidAudience = builder.Configuration["Jwt:Audience"],
            IssuerSigningKey = new SymmetricSecurityKey(
                Encoding.UTF8.GetBytes(builder.Configuration["Jwt:Key"] ?? 
                    throw new InvalidOperationException("JWT signing key must be configured via environment variable or Secret Manager"))),
            // é‡è¦ãªè¿½åŠ è¨­å®š
            ClockSkew = TimeSpan.Zero, // ã¾ãŸã¯ TimeSpan.FromMinutes(5) ã§å°ã•ãªè¨±å®¹ç¯„å›²ã‚’è¨­å®š
            RoleClaimType = ClaimTypes.Role, // ã¾ãŸã¯ "role" / "roles" ã‚’æŒ‡å®š
            NameClaimType = ClaimTypes.Name, // ã¾ãŸã¯ "name" / "sub" ã‚’æŒ‡å®š
            // ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™æ¤œè¨¼ã®å³å¯†åŒ–
            ValidateTokenReplay = true
        };
        
        // ã‚¯ãƒƒã‚­ãƒ¼ã‹ã‚‰ã®JWTãƒˆãƒ¼ã‚¯ãƒ³æŠ½å‡ºè¨­å®š
        options.Events = new JwtBearerEvents
        {
            OnMessageReceived = context =>
            {
                // ã‚¯ãƒƒã‚­ãƒ¼ã‹ã‚‰JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŠ½å‡º
                if (context.Request.Cookies.ContainsKey("access_token"))
                {
                    context.Token = context.Request.Cookies["access_token"];
                }
                return Task.CompletedTask;
            }
        };
        
        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–è¨­å®š
        options.RequireHttpsMetadata = true;
        options.SaveToken = false; // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’HttpContextã«ä¿å­˜ã—ãªã„
    });

// JWTè¨­å®šã®é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ
// 1. ClockSkew: ã‚µãƒ¼ãƒãƒ¼é–“ã®æ™‚åˆ»å·®ã‚’è¨±å®¹ã™ã‚‹ç¯„å›²ï¼ˆTimeSpan.Zeroã§å³å¯†ã€TimeSpan.FromMinutes(5)ã§5åˆ†ã®è¨±å®¹ç¯„å›²ï¼‰
// 2. RoleClaimType/NameClaimType: JWTã‚¯ãƒ¬ãƒ¼ãƒ ã®åå‰ã‚’æŒ‡å®šï¼ˆClaimTypes.Role/ClaimTypes.Nameã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ åï¼‰
// 3. OnMessageReceived: ã‚¯ãƒƒã‚­ãƒ¼ã‹ã‚‰ã®JWTãƒˆãƒ¼ã‚¯ãƒ³æŠ½å‡ºã‚’å®Ÿè£…ï¼ˆã‚¯ãƒƒã‚­ãƒ¼ãƒ™ãƒ¼ã‚¹èªè¨¼ã®ãŸã‚å¿…é ˆï¼‰
// 4. ValidateTokenReplay: ãƒˆãƒ¼ã‚¯ãƒ³ã®å†åˆ©ç”¨æ”»æ’ƒã‚’é˜²æ­¢

// ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ»ã‚¯ãƒƒã‚­ãƒ¼è¨­å®š
builder.Services.Configure<CookiePolicyOptions>(options =>
{
    options.MinimumSameSitePolicy = SameSiteMode.Strict;
    options.HttpOnly = HttpOnlyPolicy.Always;
    options.Secure = CookieSecurePolicy.Always;
});

// CSRFä¿è­·ã®è¨­å®š
builder.Services.AddAntiforgery(options =>
{
    options.HeaderName = "X-CSRF-TOKEN";
    options.Cookie.SecurePolicy = CookieSecurePolicy.Always;
    options.Cookie.HttpOnly = true;
    options.Cookie.SameSite = SameSiteMode.Strict;
});

// èªå¯ãƒãƒªã‚·ãƒ¼ã®è¨­å®š
builder.Services.AddAuthorization(options => {
    options.AddPolicy("AdminOnly", policy => policy.RequireRole("Admin"));
    options.AddPolicy("ManagerOnly", policy => policy.RequireRole("IncidentManager"));
    options.AddPolicy("WarehouseStaff", policy => policy.RequireRole("WarehouseStaff"));
    options.AddPolicy("ClerkOrAbove", policy => policy.RequireRole("Clerk", "IncidentManager", "WarehouseStaff", "Admin"));
});

// JWTè¨­å®šã®è©³ç´°èª¬æ˜
// ==========================================
// ä»¥ä¸‹ã®è¨­å®šã¯ã€ã‚»ã‚­ãƒ¥ã‚¢ãªJWTèªè¨¼ã®å®Ÿè£…ã«å¿…é ˆã§ã™ï¼š
//
// 1. ClockSkewè¨­å®š
//    - TimeSpan.Zero: å³å¯†ãªæ™‚åˆ»æ¤œè¨¼ï¼ˆæ¨å¥¨ï¼‰
//    - TimeSpan.FromMinutes(5): 5åˆ†ã®è¨±å®¹ç¯„å›²ï¼ˆã‚µãƒ¼ãƒãƒ¼é–“æ™‚åˆ»å·®ãŒã‚ã‚‹å ´åˆï¼‰
//    - æœ¬ç•ªç’°å¢ƒã§ã¯å³å¯†ãªè¨­å®šã‚’æ¨å¥¨
//
// 2. ã‚¯ãƒ¬ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—è¨­å®š
//    - RoleClaimType: ãƒ­ãƒ¼ãƒ«æƒ…å ±ã®ã‚¯ãƒ¬ãƒ¼ãƒ åï¼ˆClaimTypes.Role ã¾ãŸã¯ "role"ï¼‰
//    - NameClaimType: ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ã‚¯ãƒ¬ãƒ¼ãƒ åï¼ˆClaimTypes.Name ã¾ãŸã¯ "name"ï¼‰
//    - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ä½¿ç”¨ã™ã‚‹ã‚¯ãƒ¬ãƒ¼ãƒ åã¨ä¸€è‡´ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
//
// 3. ã‚¯ãƒƒã‚­ãƒ¼ã‹ã‚‰ã®ãƒˆãƒ¼ã‚¯ãƒ³æŠ½å‡º
//    - OnMessageReceivedã‚¤ãƒ™ãƒ³ãƒˆã§ã‚¯ãƒƒã‚­ãƒ¼ã‹ã‚‰JWTã‚’æŠ½å‡º
//    - ã‚¯ãƒƒã‚­ãƒ¼ãƒ™ãƒ¼ã‚¹èªè¨¼ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«å¿…é ˆ
//    - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šã®ãŸã‚ã€HttpOnlyã‚¯ãƒƒã‚­ãƒ¼ã§ã®ä¿å­˜ãŒå¯èƒ½
//
// 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–è¨­å®š
//    - ValidateTokenReplay: ãƒˆãƒ¼ã‚¯ãƒ³å†åˆ©ç”¨æ”»æ’ƒã®é˜²æ­¢
//    - RequireHttpsMetadata: HTTPSå¿…é ˆ
//    - SaveToken: falseï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’HttpContextã«ä¿å­˜ã—ãªã„ï¼‰
//
// 5. ã‚­ãƒ¼è­˜åˆ¥å­ï¼ˆkidï¼‰è¨­å®š
//    - JWTãƒ˜ãƒƒãƒ€ãƒ¼ã«kidã‚’å«ã‚ã‚‹ï¼ˆã‚­ãƒ¼ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
//    - å„ç½²åã‚­ãƒ¼ã«ä¸€æ„ã®è­˜åˆ¥å­ã‚’ä»˜ä¸
//    - ã‚­ãƒ¼ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã®æ–°æ—§ã‚­ãƒ¼è­˜åˆ¥ã«å¿…é ˆ
//
// 6. ç½²åã‚­ãƒ¼ç®¡ç†
//    - ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯Secret Managerã§ã®ç®¡ç†å¿…é ˆ
//    - æœ€å°ã‚­ãƒ¼é•·256ãƒ“ãƒƒãƒˆï¼ˆ512ãƒ“ãƒƒãƒˆæ¨å¥¨ï¼‰
//    - ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å®Œå…¨æ’é™¤

// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®è¿½åŠ ï¼ˆUseRoutingã®å¾Œã«é…ç½®ï¼‰
app.UseCookiePolicy();
app.UseAuthentication();
app.UseAuthorization();
app.UseAntiforgery();
```

#### 1.3 æ—¢å­˜ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¸ã®èªè¨¼ãƒ»èªå¯å±æ€§è¿½åŠ 

**IncidentsController.cs:**
```csharp
[Authorize] // å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«èªè¨¼å¿…é ˆ
[ApiController]
[Route("api/[controller]")]
public class IncidentsController : ControllerBase
{
    [Authorize(Roles = "Clerk,IncidentManager,WarehouseStaff,Admin")]
    [HttpGet]
    public async Task<ActionResult<PagedResultDto<IncidentDto>>> GetIncidents([FromQuery] GetIncidentsQuery query)
    {
        // æ—¢å­˜ã®å®Ÿè£…
    }

    [Authorize(Roles = "Clerk,IncidentManager,WarehouseStaff,Admin")]
    [HttpPost]
    public async Task<ActionResult<IncidentDto>> CreateIncident([FromBody] CreateIncidentDto dto)
    {
        // æ—¢å­˜ã®å®Ÿè£… + ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®è¿½åŠ 
        var userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        dto.CreatedByUserId = int.Parse(userId);
        // æ—¢å­˜ã®å®Ÿè£…
    }

    [Authorize(Roles = "IncidentManager,Admin")]
    [HttpPut("{id}/classify")]
    public async Task<ActionResult> ClassifyIncident(int id, [FromBody] ClassifyIncidentDto dto)
    {
        // æ—¢å­˜ã®å®Ÿè£…
    }
}
```

**WarehousesController.cs:**
```csharp
[Authorize(Roles = "WarehouseStaff,Admin")]
[ApiController]
[Route("api/[controller]")]
public class WarehousesController : ControllerBase
{
    // æ—¢å­˜ã®å®Ÿè£…ï¼ˆå€‰åº«æ‹…å½“ãƒ»ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰
}
```

**StatisticsController.cs:**
```csharp
[Authorize(Roles = "Clerk,IncidentManager,WarehouseStaff,Admin")]
[ApiController]
[Route("api/[controller]")]
public class StatisticsController : ControllerBase
{
    // æ—¢å­˜ã®å®Ÿè£…ï¼ˆå…¨ãƒ­ãƒ¼ãƒ«ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰
}
```

**MasterDataControllers:**
```csharp
[Authorize(Roles = "Admin")]
[ApiController]
[Route("api/[controller]")]
public class IncidentTypesController : ControllerBase
{
    // æ—¢å­˜ã®å®Ÿè£…ï¼ˆç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰
}
```

### 2. DTOãƒ»ãƒ¢ãƒ‡ãƒ«ã®æ‹¡å¼µ

#### 2.1 å½±éŸ¿ã‚’å—ã‘ã‚‹DTO
**æ—¢å­˜ã®ä½œæˆãƒ»æ›´æ–°DTOã¸ã®è¿½åŠ :**
```csharp
// CreateIncidentDto
public class CreateIncidentDto : IValidatableObject
{
    // æ—¢å­˜ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£...
    
    // æ–°è¦è¿½åŠ ï¼ˆèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰è‡ªå‹•è¨­å®šï¼‰
    public int CreatedByUserId { get; set; }
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
}

// UpdateIncidentDto
public class UpdateIncidentDto : IValidatableObject
{
    // æ—¢å­˜ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£...
    
    // æ–°è¦è¿½åŠ 
    public int UpdatedByUserId { get; set; }
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
}
```

**æ—¢å­˜ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹DTOã¸ã®è¿½åŠ :**
```csharp
// IncidentDto
public class IncidentDto
{
    // æ—¢å­˜ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£...
    
    // æ–°è¦è¿½åŠ 
    public int CreatedByUserId { get; set; }
    public string CreatedByUserName { get; set; }
    public DateTime CreatedAt { get; set; }
    public int? UpdatedByUserId { get; set; }
    public string UpdatedByUserName { get; set; }
    public DateTime? UpdatedAt { get; set; }
}
```

#### 2.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ»ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å½±éŸ¿

**æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã®ä½œæˆ:**
```sql
-- Incidentsãƒ†ãƒ¼ãƒ–ãƒ«ã®æ–°è¦ä½œæˆï¼ˆèªè¨¼æ©Ÿèƒ½å¯¾å¿œç‰ˆï¼‰
CREATE TABLE Incidents (
    Id INT PRIMARY KEY IDENTITY(1,1),
    Title NVARCHAR(200) NOT NULL,
    Description NVARCHAR(MAX) NULL,
    Status INT NOT NULL,
    Priority INT NOT NULL,
    IncidentTypeId INT NOT NULL,
    WarehouseId INT NOT NULL,
    CreatedByUserId INT NOT NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    UpdatedByUserId INT NULL,
    UpdatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    FOREIGN KEY (IncidentTypeId) REFERENCES IncidentTypes(Id),
    FOREIGN KEY (WarehouseId) REFERENCES Warehouses(Id),
    FOREIGN KEY (CreatedByUserId) REFERENCES Users(Id),
    FOREIGN KEY (UpdatedByUserId) REFERENCES Users(Id)
);

-- æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚‹å ´åˆã®æ‹¡å¼µï¼ˆé–‹ç™ºç’°å¢ƒã§ã®ç§»è¡Œç”¨ï¼‰
-- ALTER TABLE Incidents ADD
--     CreatedByUserId INT NULL,
--     CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
--     UpdatedByUserId INT NULL,
--     UpdatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE();

-- æ—¢å­˜Roleãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„è¿½åŠ 
ALTER TABLE Users ADD CONSTRAINT FK_Users_Role 
    FOREIGN KEY (Role) REFERENCES Roles(Id);
```

**åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥ç”¨SQL:**
```sql
-- ãƒ­ãƒ¼ãƒ«ã®åˆæœŸãƒ‡ãƒ¼ã‚¿
INSERT INTO Roles (Name, Description, IsActive) VALUES
('Clerk', 'äº‹å‹™å“¡ - åŸºæœ¬çš„ãªã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç®¡ç†', 1),
('IncidentManager', 'ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆç®¡ç†è€… - ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆåˆ†é¡ãƒ»ç®¡ç†', 1),
('WarehouseStaff', 'å€‰åº«æ‹…å½“ - è§£æ±ºç­–æ¤œè¨ãƒ»ç™»éŒ²', 1),
('Admin', 'ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€… - å…¨æ©Ÿèƒ½ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†', 1);

-- ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆï¼ˆåˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: Admin123!ï¼‰
INSERT INTO Users (Username, Email, Role, PasswordHash, TokenVersion, IsActive, CreatedAt, UpdatedAt) VALUES
('admin', 'admin@example.com', 4, '$2a$11$YourHashedPasswordHere', 1, 1, GETUTCDATE(), GETUTCDATE());

-- ãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆï¼ˆåˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: Test123!ï¼‰
INSERT INTO Users (Username, Email, Role, PasswordHash, TokenVersion, IsActive, CreatedAt, UpdatedAt) VALUES
('clerk1', 'clerk1@example.com', 1, '$2a$11$YourHashedPasswordHere', 1, 1, GETUTCDATE(), GETUTCDATE()),
('manager1', 'manager1@example.com', 2, '$2a$11$YourHashedPasswordHere', 1, 1, GETUTCDATE(), GETUTCDATE()),
('warehouse1', 'warehouse1@example.com', 3, '$2a$11$YourHashedPasswordHere', 1, 1, GETUTCDATE(), GETUTCDATE());

-- ãƒ†ã‚¹ãƒˆç”¨ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
INSERT INTO Incidents (Title, Description, Status, Priority, IncidentTypeId, WarehouseId, CreatedByUserId, CreatedAt, UpdatedAt) VALUES
('ãƒ†ã‚¹ãƒˆã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ1', 'ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºæ®µéšã§ã®ãƒ†ã‚¹ãƒˆç”¨ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ', 1, 2, 1, 1, 1, GETUTCDATE(), GETUTCDATE()),
('ãƒ†ã‚¹ãƒˆã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ2', 'èªè¨¼æ©Ÿèƒ½å®Ÿè£…å‰ã®ãƒ†ã‚¹ãƒˆç”¨ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ', 1, 1, 2, 1, 1, GETUTCDATE(), GETUTCDATE());
```

### 3. ãƒªãƒã‚¸ãƒˆãƒªãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã®å¤‰æ›´

#### 3.1 å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚µãƒ¼ãƒ“ã‚¹
**IncidentService.cs:**
```csharp
public async Task<IncidentDto> CreateIncidentAsync(CreateIncidentDto dto, int userId)
{
    // æ—¢å­˜ã®å®Ÿè£…...
    
    // æ–°è¦è¿½åŠ 
    incident.CreatedByUserId = userId;
    incident.CreatedAt = DateTime.UtcNow;
    
    // æ—¢å­˜ã®å®Ÿè£…...
}

public async Task<IncidentDto> UpdateIncidentAsync(int id, UpdateIncidentDto dto, int userId)
{
    // æ—¢å­˜ã®å®Ÿè£…...
    
    // æ–°è¦è¿½åŠ 
    incident.UpdatedByUserId = userId;
    incident.UpdatedAt = DateTime.UtcNow;
    
    // æ—¢å­˜ã®å®Ÿè£…...
}
```

#### 3.2 ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å–å¾—
**BaseController.csï¼ˆæ–°è¦ä½œæˆï¼‰:**
```csharp
[ApiController]
public abstract class BaseController : ControllerBase
{
    protected int GetCurrentUserId()
    {
        var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier);
        if (userIdClaim == null || !int.TryParse(userIdClaim.Value, out int userId))
        {
            throw new UnauthorizedAccessException("ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒå–å¾—ã§ãã¾ã›ã‚“");
        }
        return userId;
    }

    protected string GetCurrentUserRole()
    {
        var roleClaim = User.FindFirst(ClaimTypes.Role);
        return roleClaim?.Value ?? string.Empty;
    }
}
```

### 4. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ‹¡å¼µ

#### 4.1 æ—¢å­˜ã®ExceptionHandlingMiddlewareã¸ã®è¿½åŠ 
```csharp
public class ExceptionHandlingMiddleware
{
    // æ—¢å­˜ã®å®Ÿè£…...
    
    private async Task HandleExceptionAsync(HttpContext context, Exception exception)
    {
        context.Response.ContentType = "application/json";
        
        var (statusCode, message, code) = exception switch
        {
            // æ—¢å­˜ã®ã‚±ãƒ¼ã‚¹...
            
            // æ–°è¦è¿½åŠ 
            UnauthorizedAccessException => (401, "èªè¨¼ãŒå¿…è¦ã§ã™", "UNAUTHORIZED"),
            ForbiddenException => (403, "ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“", "FORBIDDEN"),
            InvalidTokenException => (401, "ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™", "INVALID_TOKEN"),
            TokenExpiredException => (401, "ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™", "TOKEN_EXPIRED"),
            
            // æ—¢å­˜ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚±ãƒ¼ã‚¹...
            _ => (500, "å†…éƒ¨ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", "INTERNAL_ERROR")
        };
        
        context.Response.StatusCode = statusCode;
        await context.Response.WriteAsJsonAsync(new
        {
            error = message,
            code = code,
            timestamp = DateTime.UtcNow
        });
    }
}
```

#### 4.2 ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹ã®è¿½åŠ 
```csharp
public class ForbiddenException : Exception
{
    public ForbiddenException(string message = "ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“") : base(message) { }
}

public class InvalidTokenException : Exception
{
    public InvalidTokenException(string message = "ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã§ã™") : base(message) { }
}

public class TokenExpiredException : Exception
{
    public TokenExpiredException(string message = "ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™") : base(message) { }
}
```

### 5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å¤‰æ›´

#### 5.1 æ—¢å­˜ã®api.tsã¸ã®å½±éŸ¿
```typescript
// æ—¢å­˜ã®api.tsã«è¿½åŠ 
import { getAuthToken, logout } from '@/lib/auth';

const apiClient = axios.create({
    baseURL: '/api',
    headers: {
        'Content-Type': 'application/json',
    },
});

// èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®è‡ªå‹•ä»˜ä¸
apiClient.interceptors.request.use((config) => {
    const token = getAuthToken();
    if (token) {
        config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
});

// èªè¨¼ã‚¨ãƒ©ãƒ¼ã®è‡ªå‹•å‡¦ç†
apiClient.interceptors.response.use(
    (response) => response,
    (error) => {
        if (error.response?.status === 401) {
            // è‡ªå‹•ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
            logout();
            window.location.href = '/login';
        }
        return Promise.reject(error);
    }
);

// æ—¢å­˜ã®APIé–¢æ•°ã¯å¤‰æ›´ä¸è¦ï¼ˆèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒè‡ªå‹•ã§ä»˜ä¸ã•ã‚Œã‚‹ï¼‰
export const getIncidents = async (params: GetIncidentsQuery): Promise<PagedResultDto<IncidentDto>> => {
    const response = await apiClient.get('/incidents', { params });
    return response.data;
};
```

#### 5.2 æ—¢å­˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¸ã®å½±éŸ¿
**æ—¢å­˜ã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆä¸€è¦§ãƒ»è©³ç´°ç”»é¢:**
- èªè¨¼çŠ¶æ…‹ã®ç¢ºèª
- æ¨©é™ã«å¿œã˜ãŸãƒœã‚¿ãƒ³ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºãƒ»éè¡¨ç¤º
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ‹¡å¼µ

```typescript
// æ—¢å­˜ã®IncidentList.tsxã¸ã®è¿½åŠ 
const IncidentList = () => {
    const { user } = useAuth(); // æ–°è¦è¿½åŠ 
    
    // æ—¢å­˜ã®å®Ÿè£…...
    
    // æ¨©é™ã«å¿œã˜ãŸè¡¨ç¤ºåˆ¶å¾¡
    const canCreateIncident = ['Clerk', 'IncidentManager', 'WarehouseStaff', 'Admin'].includes(user?.role);
    const canDeleteIncident = user?.role === 'Admin';
    
    return (
        <div>
            {/* æ—¢å­˜ã®å®Ÿè£…... */}
            
            {canCreateIncident && (
                <Button onClick={handleCreateIncident}>æ–°è¦ä½œæˆ</Button>
            )}
            
            {/* æ—¢å­˜ã®å®Ÿè£…... */}
        </div>
    );
};
```

### 6. ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®æ›´æ–°

#### 6.1 æ—¢å­˜ã®å˜ä½“ãƒ†ã‚¹ãƒˆã¸ã®å½±éŸ¿
```csharp
// æ—¢å­˜ã®IncidentControllerTests.csã¸ã®è¿½åŠ 
[Test]
public async Task CreateIncident_WithValidData_ShouldSucceed()
{
    // æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆ...
    
    // æ–°è¦è¿½åŠ ï¼šèªè¨¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®è¨­å®š
    var user = new ClaimsPrincipal(new ClaimsIdentity(new[]
    {
        new Claim(ClaimTypes.NameIdentifier, "1"),
        new Claim(ClaimTypes.Role, "Clerk")
    }, "Test"));
    
    _controller.ControllerContext = new ControllerContext
    {
        HttpContext = new DefaultHttpContext { User = user }
    };
    
    // æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆ...
}

[Test]
public async Task CreateIncident_WithoutAuthentication_ShouldReturnUnauthorized()
{
    // æ–°è¦ãƒ†ã‚¹ãƒˆï¼šèªè¨¼ãªã—ã®å ´åˆ
    var dto = new CreateIncidentDto { /* æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ */ };
    
    var result = await _controller.CreateIncident(dto);
    
    Assert.That(result.Result, Is.InstanceOf<UnauthorizedResult>());
}
```

### 7. æ®µéšçš„ç§»è¡Œã®ãŸã‚ã®è¨­å®š

#### 7.1 èªè¨¼ã®æ®µéšçš„é©ç”¨ã¨ç’°å¢ƒåˆ¥è¨­å®š

**ç’°å¢ƒåˆ¥ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š:**
- **é–‹ç™ºç’°å¢ƒ**: `RequireAuth = false`ï¼ˆèªè¨¼ãªã—ã§é–‹ç™ºå¯èƒ½ï¼‰
- **ãƒ†ã‚¹ãƒˆç’°å¢ƒ**: `RequireAuth = true`ï¼ˆèªè¨¼å¿…é ˆã§ãƒ†ã‚¹ãƒˆï¼‰
- **æœ¬ç•ªç’°å¢ƒ**: `RequireAuth = true`ï¼ˆèªè¨¼å¿…é ˆï¼‰

**appsettings.jsonï¼ˆé–‹ç™ºç’°å¢ƒï¼‰:**
```json
{
  "Authentication": {
    "RequireAuth": false, // é–‹ç™ºç’°å¢ƒã§ã¯false
    "Jwt": {
      "Issuer": "https://localhost:5001",
      "Audience": "https://localhost:5001"
      // Keyã¯ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯Secret Managerã§ç®¡ç†
    }
  }
}
```

**appsettings.Production.jsonï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰:**
```json
{
  "Authentication": {
    "RequireAuth": true, // æœ¬ç•ªç’°å¢ƒã§ã¯true
    "Jwt": {
      "Issuer": "https://your-domain.com",
      "Audience": "https://your-domain.com"
      // Keyã¯ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯Secret Managerã§ç®¡ç†
    }
  }
}
```

**ç’°å¢ƒå¤‰æ•°ã§ã®ä¸Šæ›¸ã:**
```bash
# é–‹ç™ºç’°å¢ƒã§ã®èªè¨¼æœ‰åŠ¹åŒ–
AUTHENTICATION__REQUIREAUTH=true

# æœ¬ç•ªç’°å¢ƒã§ã®èªè¨¼ç„¡åŠ¹åŒ–ï¼ˆç·Šæ€¥æ™‚ã®ã¿ï¼‰
AUTHENTICATION__REQUIREAUTH=false
```

### 8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å®Ÿè£…ã®å…·ä½“ä¾‹

#### 8.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®ã‚»ã‚­ãƒ¥ã‚¢ãªãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
```typescript
// ã‚»ã‚­ãƒ¥ã‚¢ãªãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã®å®Ÿè£…ä¾‹
class SecureTokenManager {
    private accessToken: string | null = null;
    
    // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ¡ãƒ¢ãƒªå†…ã«ä¿å­˜
    setAccessToken(token: string): void {
        this.accessToken = token;
    }
    
    // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    getAccessToken(): string | null {
        return this.accessToken;
    }
    
    // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒªã‚¢
    clearAccessToken(): void {
        this.accessToken = null;
    }
    
    // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚»ã‚­ãƒ¥ã‚¢ã‚¯ãƒƒã‚­ãƒ¼ã§ç®¡ç†ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§è¨­å®šï¼‰
    // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã¯ç›´æ¥æ“ä½œã—ãªã„
}

// CSRFä¿è­·ã®å®Ÿè£…ä¾‹
const apiClient = axios.create({
    baseURL: '/api',
    headers: {
        'X-CSRF-TOKEN': getCsrfToken(), // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’è‡ªå‹•ä»˜ä¸
    }
});

// CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—
function getCsrfToken(): string {
    // ãƒ¡ã‚¿ã‚¿ã‚°ã¾ãŸã¯å°‚ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰å–å¾—
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}
```

#### 8.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã®ã‚»ã‚­ãƒ¥ã‚¢ãªã‚¯ãƒƒã‚­ãƒ¼è¨­å®š
```csharp
// ã‚»ã‚­ãƒ¥ã‚¢ã‚¯ãƒƒã‚­ãƒ¼ã®è¨­å®šä¾‹
public class AuthController : ControllerBase
{
    [HttpPost("login")]
    public async Task<IActionResult> Login([FromBody] LoginDto dto)
    {
        // èªè¨¼å‡¦ç†...
        
        // ã‚»ã‚­ãƒ¥ã‚¢ã‚¯ãƒƒã‚­ãƒ¼ã§ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š
        var refreshTokenCookie = new CookieOptions
        {
            HttpOnly = true,
            Secure = true, // HTTPSå¿…é ˆ
            SameSite = SameSiteMode.Strict,
            MaxAge = TimeSpan.FromDays(7),
            Path = "/"
        };
        
        Response.Cookies.Append("refresh_token", refreshToken, refreshTokenCookie);
        
        // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã§è¿”ã™ï¼ˆãƒ¡ãƒ¢ãƒªå†…ä¿å­˜ç”¨ï¼‰
        return Ok(new { accessToken = accessToken });
    }
    
    [HttpPost("refresh")]
    public async Task<IActionResult> Refresh()
    {
        // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒƒã‚­ãƒ¼ã‹ã‚‰å–å¾—
        var refreshToken = Request.Cookies["refresh_token"];
        
        // ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ãƒ»æ›´æ–°å‡¦ç†...
        
        // æ–°ã—ã„ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚»ã‚­ãƒ¥ã‚¢ã‚¯ãƒƒã‚­ãƒ¼ã§è¨­å®š
        var newRefreshTokenCookie = new CookieOptions
        {
            HttpOnly = true,
            Secure = true,
            SameSite = SameSiteMode.Strict,
            MaxAge = TimeSpan.FromDays(7),
            Path = "/"
        };
        
        Response.Cookies.Append("refresh_token", newRefreshToken, newRefreshTokenCookie);
        
        return Ok(new { accessToken = newAccessToken });
    }
}
```

**Program.cs:**
```csharp
// æ®µéšçš„ç§»è¡Œã®ãŸã‚ã®æ¡ä»¶åˆ†å²
if (builder.Configuration.GetValue<bool>("Authentication:RequireAuth"))
{
    // èªè¨¼ãƒ»èªå¯ã®æœ‰åŠ¹åŒ–
    builder.Services.AddAuthentication(/* è¨­å®š */);
    builder.Services.AddAuthorization(/* è¨­å®š */);
    
    app.UseAuthentication();
    app.UseAuthorization();
}
else
{
    // èªè¨¼ãªã—ãƒ¢ãƒ¼ãƒ‰ï¼ˆé–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ï¼‰
    builder.Services.AddScoped<IAuthenticationService, NoAuthService>();
}
```

#### 7.2 æ—¢å­˜APIã®æ®µéšçš„ä¿è­·

**ã‚¢ãƒ—ãƒ­ãƒ¼ãƒA: Endpoint-group toggleï¼ˆæ¨å¥¨ï¼‰**

Program.csã§ã®æ¡ä»¶ä»˜ãèªè¨¼è¨­å®šã«ã‚ˆã‚Šã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®`Authentication:RequireAuth`ãƒ•ãƒ©ã‚°ã«åŸºã¥ã„ã¦èªè¨¼ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚ç’°å¢ƒåˆ¥ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ãŒè¨­å®šã•ã‚Œã¦ãŠã‚Šã€å¿…è¦ã«å¿œã˜ã¦ç’°å¢ƒå¤‰æ•°ã§ä¸Šæ›¸ãå¯èƒ½ã§ã™ã€‚

```csharp
// Program.csã§ã®æ¡ä»¶ä»˜ãèªè¨¼è¨­å®š
var requireAuth = builder.Configuration.GetValue<bool>("Authentication:RequireAuth", false);

if (requireAuth)
{
    // JWTèªè¨¼ã®è¨­å®š
    var jwtSettings = builder.Configuration.GetSection("Authentication:Jwt");
    var key = Encoding.ASCII.GetBytes(jwtSettings["Key"] ?? "your-secret-key-here");
    
    builder.Services.AddAuthentication(options =>
    {
        options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
        options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
    })
    .AddJwtBearer(options =>
    {
        options.RequireHttpsMetadata = false;
        options.SaveToken = true;
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuerSigningKey = true,
            IssuerSigningKey = new SymmetricSecurityKey(key),
            ValidateIssuer = true,
            ValidIssuer = jwtSettings["Issuer"],
            ValidateAudience = true,
            ValidAudience = jwtSettings["Audience"],
            ValidateLifetime = true,
            ClockSkew = TimeSpan.Zero
        };
    });
    
    builder.Services.AddAuthorization();
}

// æ¡ä»¶ä»˜ãèªè¨¼ãƒ»èªå¯ã®é©ç”¨
if (requireAuth)
{
    app.UseAuthentication();
    app.UseAuthorization();
    
    // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã«èªè¨¼ã‚’é©ç”¨
    app.MapControllers()
        .RequireAuthorization();
}
else
{
    // èªè¨¼ãŒç„¡åŠ¹ãªå ´åˆã¯ã€èªè¨¼ãªã—ã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ãƒãƒƒãƒ—
    app.MapControllers();
}
```

**è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¾‹:**
```json
{
  "Authentication": {
    "RequireAuth": false,  // é–‹ç™ºç’°å¢ƒã§ã¯falseã€æœ¬ç•ªç’°å¢ƒã§ã¯trueï¼ˆç’°å¢ƒå¤‰æ•°ã§ä¸Šæ›¸ãå¯èƒ½ï¼‰
    "Jwt": {
      "Issuer": "https://localhost:5001",
      "Audience": "https://localhost:5001",
      "ExpiryMinutes": 60
      // Keyã¯ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯Secret Managerã§ç®¡ç†
    }
  }
}
```

**åˆ©ç‚¹:**
- å±æ€§å†…ã§Configurationã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãªã„ï¼ˆé©åˆ‡ãªè¨­è¨ˆï¼‰
- DIã«ä¾å­˜ã—ãªã„
- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ¬ãƒ™ãƒ«ã§ã®æ˜ç¢ºãªåˆ¶å¾¡
- è¨­å®šå¤‰æ›´æ™‚ã®å†èµ·å‹•ãŒä¸è¦
- ASP.NET Core 8.0ã®æ¨™æº–çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³

## å®Ÿè£…è¨ˆç”»

å®Ÿè£…è¨ˆç”»ã®è©³ç´°ã¯`todo.md`ã®ã€Œãƒ•ã‚§ãƒ¼ã‚º3.29: ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½å®Ÿè£…ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 1. èªè¨¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦**: æœ€å°8æ–‡å­—ã€è¤‡é›‘æ€§è¦ä»¶
- **ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹å¯¾ç­–**: ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°åˆ¶é™
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**: ãƒˆãƒ¼ã‚¯ãƒ³ã®é©åˆ‡ãªæœ‰åŠ¹æœŸé™è¨­å®š
- **HTTPSå¿…é ˆ**: æœ¬ç•ªç’°å¢ƒã§ã®æš—å·åŒ–é€šä¿¡

### 2. èªå¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- **æœ€å°æ¨©é™ã®åŸå‰‡**: å¿…è¦æœ€å°é™ã®æ¨©é™ã®ã¿ä»˜ä¸
- **ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**: æ©Ÿèƒ½ãƒ¬ãƒ™ãƒ«ã§ã®æ¨©é™ç®¡ç†
- **APIä¿è­·**: èªè¨¼ãƒ»èªå¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®é©åˆ‡ãªé©ç”¨
- **å…¥åŠ›å€¤æ¤œè¨¼**: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®å³å¯†ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

### 3. ãƒ‡ãƒ¼ã‚¿ä¿è­·
- **å€‹äººæƒ…å ±**: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç­‰ã®æ©Ÿå¯†æƒ…å ±ã®é©åˆ‡ãªä¿è­·
- **ç›£æŸ»ãƒ­ã‚°**: èªè¨¼ãƒ»èªå¯ã‚¤ãƒ™ãƒ³ãƒˆã®è¨˜éŒ²
- **ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–**: æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–ä¿å­˜

### 4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- **ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜**: localStorage/sessionStorageã®ä½¿ç”¨ç¦æ­¢
- **ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³**: ã‚»ã‚­ãƒ¥ã‚¢ã‚¯ãƒƒã‚­ãƒ¼ã§ã®ä¿å­˜ï¼ˆHttpOnly, Secure, SameSiteï¼‰
- **ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³**: ãƒ¡ãƒ¢ãƒªå†…ä¿å­˜ã®ã¿ã€ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã¯å†èªè¨¼
- **CSRFä¿è­·**: å…¨POST/PUT/DELETEãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã®CSRFãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
- **XSSå¯¾ç­–**: å…¥åŠ›å€¤ã®é©åˆ‡ãªã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
- **HTTPSå¼·åˆ¶**: æœ¬ç•ªç’°å¢ƒã§ã®æš—å·åŒ–é€šä¿¡å¿…é ˆ

## éæ©Ÿèƒ½è¦ä»¶

### 1. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- **èªè¨¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹**: 500msä»¥å†…
- **ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼**: 100msä»¥å†…
- **åŒæ™‚æ¥ç¶šæ•°**: 100ãƒ¦ãƒ¼ã‚¶ãƒ¼

### 2. å¯ç”¨æ€§
- **ç¨¼åƒç‡**: 99.5%ä»¥ä¸Š
- **éšœå®³å¾©æ—§**: 4æ™‚é–“ä»¥å†…
- **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: æ—¥æ¬¡ãƒ•ãƒ«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

### 3. ä¿å®ˆæ€§
- **ãƒ­ã‚°å‡ºåŠ›**: æ§‹é€ åŒ–ãƒ­ã‚°ï¼ˆSerilogï¼‰
- **ç›£è¦–**: Application Insights
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

## ãƒªã‚¹ã‚¯ç®¡ç†

### 1. æŠ€è¡“çš„ãƒªã‚¹ã‚¯
- **JWTãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: é©åˆ‡ãªæš—å·åŒ–ãƒ»ç½²åã®å®Ÿè£…
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–**: æœ€æ–°ã®bcryptã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ä½¿ç”¨
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**: ãƒˆãƒ¼ã‚¯ãƒ³ã®é©åˆ‡ãªç„¡åŠ¹åŒ–å‡¦ç†

### 2. é‹ç”¨ãƒªã‚¹ã‚¯
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†**: é©åˆ‡ãªæ¨©é™è¨­å®šã¨ç›£æŸ»
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ**: ã‚»ã‚­ãƒ¥ã‚¢ãªãƒªã‚»ãƒƒãƒˆãƒ•ãƒ­ãƒ¼
- **ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯**: ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹å¯¾ç­–

### 3. å¯¾å¿œç­–
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼**: å®Ÿè£…å‰å¾Œã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
- **ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ**: å¤–éƒ¨ã‹ã‚‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
- **ç›£æŸ»ãƒ­ã‚°**: å…¨èªè¨¼ãƒ»èªå¯ã‚¤ãƒ™ãƒ³ãƒˆã®è¨˜éŒ²

## ãƒ†ã‚¹ãƒˆè¨ˆç”»

### 1. å˜ä½“ãƒ†ã‚¹ãƒˆ
- **èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹**: ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ»ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹**: ãƒãƒƒã‚·ãƒ¥åŒ–ãƒ»æ¤œè¨¼
- **èªå¯ã‚µãƒ¼ãƒ“ã‚¹**: ãƒ­ãƒ¼ãƒ«ãƒ»æ¨©é™ãƒã‚§ãƒƒã‚¯

### 2. çµ±åˆãƒ†ã‚¹ãƒˆ
- **APIèªè¨¼**: ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã®èªè¨¼ãƒ»èªå¯
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ãƒ­ãƒ¼ãƒ«ç®¡ç†ã®æ•´åˆæ€§
- **ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢**: èªè¨¼ãƒ»èªå¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®å‹•ä½œ

### 3. E2Eãƒ†ã‚¹ãƒˆ
- **ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼**: æ­£å¸¸ãƒ»ç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç¢ºèª
- **ãƒ­ãƒ¼ãƒ«åˆ¥ã‚¢ã‚¯ã‚»ã‚¹**: å„ãƒ­ãƒ¼ãƒ«ã§ã®æ©Ÿèƒ½åˆ©ç”¨ç¢ºèª
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã®é˜²æ­¢ç¢ºèª

## é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç’°å¢ƒæ§‹ç¯‰è¨ˆç”»

### 1. é–‹ç™ºç’°å¢ƒã®æº–å‚™
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã§ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ
- **åˆæœŸãƒ‡ãƒ¼ã‚¿**: ãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ãƒ­ãƒ¼ãƒ«ãƒ»ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥
- **èªè¨¼è¨­å®š**: JWTè¨­å®šã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ã®è¨­å®š

### 2. æ®µéšçš„å®Ÿè£…
- **Phase 1**: èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…ãƒ»å˜ä½“ãƒ†ã‚¹ãƒˆ
- **Phase 2**: æ—¢å­˜æ©Ÿèƒ½ã¸ã®èªè¨¼ãƒ»èªå¯é©ç”¨ãƒ»çµ±åˆãƒ†ã‚¹ãƒˆ
- **Phase 3**: ãƒ­ãƒ¼ãƒ«åˆ¥ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®å®Ÿè£…ãƒ»E2Eãƒ†ã‚¹ãƒˆ
- **Phase 4**: æœ¬æ ¼é‹ç”¨é–‹å§‹ãƒ»ç›£è¦–ãƒ»ãƒ­ã‚°ç¢ºèª

### 3. é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿
- **ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼**: å„ãƒ­ãƒ¼ãƒ«ã®ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
- **ãƒ†ã‚¹ãƒˆã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ**: èªè¨¼æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿
- **æ¨©é™ãƒ†ã‚¹ãƒˆ**: å„ãƒ­ãƒ¼ãƒ«ã§ã®æ©Ÿèƒ½ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèªç”¨ãƒ‡ãƒ¼ã‚¿

## ä»Šå¾Œã®æ‹¡å¼µæ€§

### 1. èªè¨¼æ–¹å¼ã®æ‹¡å¼µ
- **å¤šè¦ç´ èªè¨¼**: SMSãƒ»ãƒ¡ãƒ¼ãƒ«ãƒ»ã‚¢ãƒ—ãƒªèªè¨¼
- **SSOé€£æº**: Active Directoryãƒ»LDAPé€£æº
- **OAuth 2.0**: å¤–éƒ¨èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼é€£æº

### 2. æ¨©é™ç®¡ç†ã®æ‹¡å¼µ
- **ç´°ç²’åº¦æ¨©é™**: æ©Ÿèƒ½ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ¬ãƒ™ãƒ«ã§ã®æ¨©é™ç®¡ç†
- **å‹•çš„æ¨©é™**: æ¥­å‹™çŠ¶æ³ã«å¿œã˜ãŸæ¨©é™å¤‰æ›´
- **æ¨©é™å§”è­²**: ä¸€æ™‚çš„ãªæ¨©é™å§”è­²æ©Ÿèƒ½

### 3. ç›£æŸ»ãƒ»ç›£è¦–ã®æ‹¡å¼µ
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–**: èªè¨¼ãƒ»èªå¯ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
- **ç•°å¸¸æ¤œçŸ¥**: ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è‡ªå‹•æ¤œçŸ¥
- **ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã®è‡ªå‹•ç”Ÿæˆ

## JWTè¨­å®šã®å®Ÿè£…ä¾‹ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. å®Œå…¨ãªJWTè¨­å®šä¾‹

```csharp
// Program.cs ã§ã®å®Œå…¨ãªJWTè¨­å®š
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options => {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            // åŸºæœ¬æ¤œè¨¼è¨­å®š
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            
            // ç™ºè¡Œè€…ãƒ»å¯¾è±¡è€…ãƒ»ç½²åã‚­ãƒ¼è¨­å®š
            ValidIssuer = builder.Configuration["Jwt:Issuer"],
            ValidAudience = builder.Configuration["Jwt:Audience"],
            IssuerSigningKey = new SymmetricSecurityKey(
                Encoding.UTF8.GetBytes(builder.Configuration["Jwt:Key"] ?? 
                    throw new InvalidOperationException("JWT signing key must be configured via environment variable or Secret Manager"))),
            
            // é‡è¦ãªè¿½åŠ è¨­å®šï¼ˆå¿…é ˆï¼‰
            ClockSkew = TimeSpan.Zero, // å³å¯†ãªæ™‚åˆ»æ¤œè¨¼
            RoleClaimType = ClaimTypes.Role, // ãƒ­ãƒ¼ãƒ«ã‚¯ãƒ¬ãƒ¼ãƒ å
            NameClaimType = ClaimTypes.Name, // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚¯ãƒ¬ãƒ¼ãƒ å
            ValidateTokenReplay = true, // ãƒˆãƒ¼ã‚¯ãƒ³å†åˆ©ç”¨æ”»æ’ƒé˜²æ­¢
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®š
            ValidateActor = false, // å¿…è¦ã«å¿œã˜ã¦æœ‰åŠ¹åŒ–
            ValidateTokenReplay = true, // ãƒˆãƒ¼ã‚¯ãƒ³å†åˆ©ç”¨æ”»æ’ƒé˜²æ­¢
            RequireExpirationTime = true, // æœ‰åŠ¹æœŸé™å¿…é ˆ
            RequireSignedTokens = true // ç½²åå¿…é ˆ
        };
        
        // ã‚¯ãƒƒã‚­ãƒ¼ã‹ã‚‰ã®JWTãƒˆãƒ¼ã‚¯ãƒ³æŠ½å‡ºï¼ˆã‚¯ãƒƒã‚­ãƒ¼ãƒ™ãƒ¼ã‚¹èªè¨¼ç”¨ï¼‰
        options.Events = new JwtBearerEvents
        {
            OnMessageReceived = context =>
            {
                // ã‚¯ãƒƒã‚­ãƒ¼ã‹ã‚‰JWTãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŠ½å‡º
                if (context.Request.Cookies.ContainsKey("access_token"))
                {
                    context.Token = context.Request.Cookies["access_token"];
                }
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ã®æŠ½å‡ºã‚‚ä½µç”¨ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                if (string.IsNullOrEmpty(context.Token))
                {
                    var authHeader = context.Request.Headers["Authorization"].FirstOrDefault();
                    if (!string.IsNullOrEmpty(authHeader) && authHeader.StartsWith("Bearer "))
                    {
                        context.Token = authHeader.Substring("Bearer ".Length);
                    }
                }
                
                return Task.CompletedTask;
            },
            
            // èªè¨¼å¤±æ•—æ™‚ã®ã‚«ã‚¹ã‚¿ãƒ å‡¦ç†
            OnAuthenticationFailed = context =>
            {
                // ãƒ­ã‚°å‡ºåŠ›ã‚„ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
                return Task.CompletedTask;
            }
        };
        
        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–è¨­å®š
        options.RequireHttpsMetadata = true;
        options.SaveToken = false;
    });
```

### 2. è¨­å®šç®¡ç†ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶

#### 2.1 ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯Secret Managerã§ã®ç®¡ç†å¿…é ˆåŒ–
**é‡è¦**: JWTç½²åã‚­ãƒ¼ã¯ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯Secret Managerã§ç®¡ç†ã—ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚

**ç’°å¢ƒå¤‰æ•°ã§ã®è¨­å®šä¾‹:**
```bash
# æœ¬ç•ªç’°å¢ƒ
JWT__KEY=your-super-secret-key-with-at-least-256-bits
JWT__ISSUER=https://your-domain.com
JWT__AUDIENCE=https://your-domain.com

# é–‹ç™ºç’°å¢ƒ
JWT__KEY=dev-secret-key-for-development-only
JWT__ISSUER=https://localhost:5001
JWT__AUDIENCE=https://localhost:5001
```

**Secret Managerã§ã®è¨­å®šä¾‹:**
```bash
# é–‹ç™ºç’°å¢ƒ
dotnet user-secrets set "Jwt:Key" "dev-secret-key-for-development-only"
dotnet user-secrets set "Jwt:Issuer" "https://localhost:5001"
dotnet user-secrets set "Jwt:Audience" "https://localhost:5001"

# æœ¬ç•ªç’°å¢ƒï¼ˆAzure Key Vaultç­‰ï¼‰
# ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§Key Vaultæ¥ç¶šæƒ…å ±ã‚’æŒ‡å®š
```

#### 2.2 appsettings.jsonã§ã®è¨­å®šä¾‹ï¼ˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæƒ…å ±ãªã—ï¼‰
```json
{
  "Jwt": {
    "Issuer": "https://your-domain.com",
    "Audience": "https://your-domain.com",
    "AccessTokenExpirationMinutes": 15,
    "RefreshTokenExpirationDays": 7,
    "KeyRotationEnabled": true,
    "KeyRotationIntervalDays": 90
  }
}
```

### 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

#### 3.1 ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®š
- **ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™**: 15åˆ†-1æ™‚é–“ï¼ˆçŸ­æ™‚é–“ï¼‰
- **ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™**: 7-30æ—¥
- **ç½²åã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **: HS256ä»¥ä¸Šï¼ˆRS256æ¨å¥¨ï¼‰
- **ã‚­ãƒ¼é•·**: æœ€ä½256ãƒ“ãƒƒãƒˆï¼ˆ512ãƒ“ãƒƒãƒˆæ¨å¥¨ï¼‰**å¿…é ˆ**
- **ã‚­ãƒ¼è­˜åˆ¥å­ï¼ˆkidï¼‰**: JWTãƒ˜ãƒƒãƒ€ãƒ¼ã«å«ã‚ã‚‹**å¿…é ˆ**
- **ã‚­ãƒ¼ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**: 90æ—¥ã”ã¨ã®å®šæœŸãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**æ¨å¥¨**

#### 3.2 ã‚¯ãƒƒã‚­ãƒ¼è¨­å®š
- **HttpOnly**: å¸¸ã«trueï¼ˆJavaScriptã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢ï¼‰
- **Secure**: å¸¸ã«trueï¼ˆHTTPSå¿…é ˆï¼‰
- **SameSite**: Strictï¼ˆCSRFæ”»æ’ƒé˜²æ­¢ï¼‰
- **Domain**: å¿…è¦æœ€å°é™ã®ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š

#### 3.3 ã‚­ãƒ¼ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ”¿ç­–

**ã‚­ãƒ¼ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…è¦ä»¶:**
- **ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³é–“éš”**: 90æ—¥ã”ã¨ï¼ˆè¨­å®šå¯èƒ½ï¼‰
- **é‡è¤‡æœ‰åŠ¹æœŸé–“**: æ–°ã‚­ãƒ¼ã¨æ—§ã‚­ãƒ¼ã®é‡è¤‡æœŸé–“ã‚’7æ—¥é–“è¨­å®š
- **ã‚­ãƒ¼è­˜åˆ¥å­ï¼ˆkidï¼‰**: å„ã‚­ãƒ¼ã«ä¸€æ„ã®è­˜åˆ¥å­ã‚’ä»˜ä¸
- **ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™**: ã‚­ãƒ¼ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³é–“éš”ã‚ˆã‚ŠçŸ­ã„æœŸé–“ã«è¨­å®š

**ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †:**
1. æ–°ã—ã„ç½²åã‚­ãƒ¼ã®ç”Ÿæˆï¼ˆ256ãƒ“ãƒƒãƒˆä»¥ä¸Šï¼‰
2. æ–°ã—ã„ã‚­ãƒ¼ã«ä¸€æ„ã®kidã‚’å‰²ã‚Šå½“ã¦
3. æ—§ã‚­ãƒ¼ã¨ã®é‡è¤‡æœŸé–“ä¸­ã¯ä¸¡æ–¹ã®ã‚­ãƒ¼ã§ç½²åæ¤œè¨¼ã‚’è¨±å¯
4. é‡è¤‡æœŸé–“çµ‚äº†å¾Œã€æ—§ã‚­ãƒ¼ã‚’ç„¡åŠ¹åŒ–
5. ç„¡åŠ¹åŒ–ã•ã‚ŒãŸã‚­ãƒ¼ã§ç½²åã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã®è‡ªå‹•æ‹’å¦

**å®Ÿè£…æ™‚ã®æ³¨æ„ç‚¹:**
- **ClockSkew**: æœ¬ç•ªç’°å¢ƒã§ã¯TimeSpan.Zeroã‚’æ¨å¥¨
- **ã‚¯ãƒ¬ãƒ¼ãƒ å**: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ä¸€è‡´ã•ã›ã‚‹
- **ãƒˆãƒ¼ã‚¯ãƒ³æŠ½å‡º**: ã‚¯ãƒƒã‚­ãƒ¼ã¨ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸¡æ–¹ã«å¯¾å¿œ
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: èªè¨¼å¤±æ•—æ™‚ã®é©åˆ‡ãªãƒ­ã‚°å‡ºåŠ›
- **ã‚­ãƒ¼ç®¡ç†**: ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯Secret Managerã§ã®å®‰å…¨ãªç®¡ç†
- **ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ç›£è¦–**: ã‚­ãƒ¼ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®æˆåŠŸãƒ»å¤±æ•—ã®ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ

---

**æ–‡æ›¸å±¥æ­´**

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ | å¤‰æ›´è€… |
|------|------------|----------|--------|
| 2025-09-02 | 1.0 | åˆç‰ˆä½œæˆ | ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒãƒ¼ãƒ  |
