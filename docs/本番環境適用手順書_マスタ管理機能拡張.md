# 本番環境適用手順書 - マスタ管理機能拡張

## 概要

このドキュメントは、物流トラブル管理システムのマスタ管理機能拡張を本番環境に適用するための手順書です。

### 対象機能
- フェーズ3.15: マスタ管理機能拡張
  - 3.15.1 データベース設計・作成 ✅
  - 3.15.2 バックエンド実装 ✅
  - 3.15.3 フロントエンド実装 ✅
  - 3.15.4 データ移行・テスト 🔄

### 変更内容
- `Incidents`テーブルの4つのEnumフィールドをマスタテーブルに移行
  - `TroubleType` → `TroubleTypes`テーブル
  - `DamageType` → `DamageTypes`テーブル
  - `Warehouse` → `Warehouses`テーブル
  - `ShippingCompany` → `ShippingCompanies`テーブル

---

## 前提条件

### 必須条件
- [ ] 本番環境のデータベースバックアップが取得済み
- [ ] メンテナンス時間が確保済み（推奨：30分）
- [ ] ロールバック手順が準備済み
- [ ] Entity Framework Core 9.0.8が本番環境にインストール済み
- [ ] 開発チームの待機体制が整っている

### 推奨条件
- [ ] テスト環境での事前検証完了
- [ ] ロールバック手順の事前テスト完了
- [ ] 緊急連絡体制の確認完了

---

## 1. 事前準備

### 1.1 バックアップの取得

#### 1.1.1 データベースバックアップ
```sql
-- 本番環境のデータベースバックアップ
BACKUP DATABASE LogisticsTroubleManagement 
TO DISK = 'C:\Backup\LogisticsTroubleManagement_PreMasterMigration_YYYYMMDD_HHMMSS.bak'
WITH COMPRESSION, CHECKSUM;

-- バックアップの検証
RESTORE VERIFYONLY 
FROM DISK = 'C:\Backup\LogisticsTroubleManagement_PreMasterMigration_YYYYMMDD_HHMMSS.bak';
```

#### 1.1.2 ログバックアップ（フルリカバリモデルの場合）
```sql
-- ログバックアップ
BACKUP LOG LogisticsTroubleManagement 
TO DISK = 'C:\Backup\LogisticsTroubleManagement_PreMasterMigration_YYYYMMDD_HHMMSS.trn';
```

### 1.2 現在の状態確認

#### 1.2.1 マイグレーション履歴の確認
```sql
-- 現在のマイグレーション履歴確認
SELECT * FROM __EFMigrationsHistory ORDER BY ProductVersion;

-- 期待される結果：
-- 20250818062606_InitialCreate
-- 20250818234911_UpdateModelChanges
-- 20250820050250_AddLogisticsSpecificFields
-- 20250825022322_CreateDatabaseSchema
```

#### 1.2.2 データベース状態の確認
```sql
-- 現在のテーブル構造確認
SELECT 
    TABLE_NAME,
    COLUMN_NAME,
    DATA_TYPE,
    IS_NULLABLE,
    COLUMN_DEFAULT
FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_NAME = 'Incidents'
ORDER BY TABLE_NAME, ORDINAL_POSITION;

-- 現在のデータ件数確認
SELECT 
    'Incidents' as TableName,
    COUNT(*) as RecordCount
FROM Incidents;

-- Enum値の分布確認
SELECT 
    'TroubleType' as FieldName,
    TroubleType as EnumValue,
    COUNT(*) as RecordCount
FROM Incidents 
GROUP BY TroubleType
ORDER BY TroubleType;
```

---

## 2. マイグレーション対応の適用手順

### 2.1 開発環境でのマイグレーション作成

#### 2.1.1 既存のマイグレーションをクリーンアップ
```bash
# 開発環境のInfrastructureプロジェクトディレクトリで実行
cd backend/LogisticsTroubleManagement.Infrastructure

# 既存のマイグレーションを削除（問題のあるものがあれば）
dotnet ef migrations remove --startup-project ../LogisticsTroubleManagement.API
```

#### 2.1.2 マスタテーブル作成用のマイグレーションを作成
```bash
# マスタテーブルのみを作成するマイグレーション
dotnet ef migrations add CreateMasterTablesOnly --startup-project ../LogisticsTroubleManagement.API

# 作成されたマイグレーションファイルの確認
dir Migrations
```

#### 2.1.3 マイグレーション内容の確認
作成されたマイグレーションファイル（`YYYYMMDDHHMMSS_CreateMasterTablesOnly.cs`）の内容を確認し、以下が含まれていることを確認：
- `TroubleTypes`テーブルの作成
- `DamageTypes`テーブルの作成
- `Warehouses`テーブルの作成
- `ShippingCompanies`テーブルの作成
- `Incidents`テーブルへの新規カラム追加（`TroubleTypeId`, `DamageTypeId`, `WarehouseId`, `ShippingCompanyId`）

### 2.2 本番環境でのマイグレーション適用

#### 2.2.1 マイグレーションファイルの本番環境への配置
以下のファイルを本番環境のInfrastructureプロジェクトに配置：
```
Migrations/
├── YYYYMMDDHHMMSS_CreateMasterTablesOnly.cs
├── YYYYMMDDHHMMSS_CreateMasterTablesOnly.Designer.cs
└── ApplicationDbContextModelSnapshot.cs
```

#### 2.2.2 本番環境でのマイグレーション適用
```bash
# 本番環境のInfrastructureプロジェクトディレクトリで実行
dotnet ef database update --startup-project ../LogisticsTroubleManagement.API

# 適用結果の確認
dotnet ef migrations list --startup-project ../LogisticsTroubleManagement.API
```

### 2.3 データ移行スクリプトの実行

#### 2.3.1 マスタデータの挿入
**ファイル**: `database/scripts/07_InsertMasterData.sql`

```sql
-- 実行時間: 約30秒
-- 影響: 新規データ挿入（既存データへの影響なし）

-- 実行前の確認
SELECT COUNT(*) FROM TroubleTypes;
SELECT COUNT(*) FROM DamageTypes;
SELECT COUNT(*) FROM Warehouses;
SELECT COUNT(*) FROM ShippingCompanies;

-- スクリプト実行
-- 07_InsertMasterData.sql を実行

-- 実行後の確認
SELECT COUNT(*) FROM TroubleTypes;  -- 期待値: 10
SELECT COUNT(*) FROM DamageTypes;   -- 期待値: 8
SELECT COUNT(*) FROM Warehouses;    -- 期待値: 4
SELECT COUNT(*) FROM ShippingCompanies; -- 期待値: 5
```

#### 2.3.2 Incidentsテーブルの更新
**ファイル**: `database/scripts/08_UpdateIncidentsTable.sql`

```sql
-- 実行時間: 約5-10分（データ量による）
-- 影響: 既存データの移行、テーブル構造の変更

-- 実行前の確認
SELECT 
    COUNT(*) as TotalRecords,
    COUNT(TroubleTypeId) as TroubleTypeIdCount,
    COUNT(DamageTypeId) as DamageTypeIdCount,
    COUNT(WarehouseId) as WarehouseIdCount,
    COUNT(ShippingCompanyId) as ShippingCompanyIdCount
FROM Incidents;

-- スクリプト実行
-- 08_UpdateIncidentsTable.sql を実行

-- 実行後の確認
SELECT 
    COUNT(*) as TotalRecords,
    COUNT(TroubleTypeId) as TroubleTypeIdCount,
    COUNT(DamageTypeId) as DamageTypeIdCount,
    COUNT(WarehouseId) as WarehouseIdCount,
    COUNT(ShippingCompanyId) as ShippingCompanyIdCount
FROM Incidents;
```

---

## 3. マイグレーション履歴の整合性確保

### 3.1 マイグレーション履歴の確認
```sql
-- マイグレーション履歴の確認
SELECT * FROM __EFMigrationsHistory ORDER BY ProductVersion;

-- 期待される結果：
-- 20250818062606_InitialCreate
-- 20250818234911_UpdateModelChanges
-- 20250820050250_AddLogisticsSpecificFields
-- 20250825022322_CreateDatabaseSchema
-- YYYYMMDDHHMMSS_CreateMasterTablesOnly  ← 新しく追加される
```

### 3.2 マイグレーション履歴の手動更新（必要に応じて）
```sql
-- マイグレーション履歴が正しく更新されていない場合
INSERT INTO __EFMigrationsHistory (MigrationId, ProductVersion)
VALUES ('YYYYMMDDHHMMSS_CreateMasterTablesOnly', '9.0.8');

-- 確認
SELECT * FROM __EFMigrationsHistory ORDER BY ProductVersion;
```

---

## 4. 実行時の注意事項

### 4.1 実行順序の厳守
1. **マイグレーション適用** → 2. **07_InsertMasterData.sql** → 3. **08_UpdateIncidentsTable.sql**

### 4.2 マイグレーション適用時の注意
- 本番環境でのマイグレーション適用前に、必ずバックアップを取得
- マイグレーション適用中はアプリケーションを停止
- エラーが発生した場合は即座に停止
- 各ステップでの確認作業を必ず実行

### 4.3 データ移行スクリプト実行時の注意
- 各ステップでの確認作業を必ず実行
- 移行結果の詳細確認
- エラーが発生した場合のロールバック準備
- 依存関係エラーが発生した場合の対応

---

## 5. 実行後の確認

### 5.1 マイグレーション履歴の確認
```sql
-- マイグレーション履歴の最終確認
SELECT * FROM __EFMigrationsHistory ORDER BY ProductVersion;
```

### 5.2 テーブル構造の確認
```sql
-- 最終的なテーブル構造確認
SELECT 
    COLUMN_NAME,
    DATA_TYPE,
    IS_NULLABLE,
    COLUMN_DEFAULT
FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_NAME = 'Incidents'
ORDER BY ORDINAL_POSITION;

-- 期待される結果：
-- 古いEnumカラム（TroubleType, DamageType, Warehouse, ShippingCompany）が削除されている
-- 新しいIDカラム（TroubleTypeId, DamageTypeId, WarehouseId, ShippingCompanyId）がNOT NULLで存在
```

### 5.3 外部キー制約の確認
```sql
-- 外部キー制約の確認
SELECT 
    tc.CONSTRAINT_NAME,
    tc.TABLE_NAME,
    kcu.COLUMN_NAME,
    ccu.TABLE_NAME AS FOREIGN_TABLE_NAME,
    ccu.COLUMN_NAME AS FOREIGN_COLUMN_NAME
FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS AS tc
JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE AS kcu
    ON tc.CONSTRAINT_NAME = kcu.CONSTRAINT_NAME
JOIN INFORMATION_SCHEMA.CONSTRAINT_COLUMN_USAGE AS ccu
    ON ccu.CONSTRAINT_NAME = tc.CONSTRAINT_NAME
WHERE tc.CONSTRAINT_TYPE = 'FOREIGN KEY'
    AND tc.TABLE_NAME = 'Incidents';

-- 期待される結果：
-- FK_Incidents_TroubleTypes
-- FK_Incidents_DamageTypes
-- FK_Incidents_Warehouses
-- FK_Incidents_ShippingCompanies
```

### 5.4 データ整合性の確認
```sql
-- マスタデータとの整合性確認
SELECT 
    'TroubleTypes' as TableName,
    COUNT(*) as RecordCount
FROM TroubleTypes
UNION ALL
SELECT 
    'DamageTypes',
    COUNT(*)
FROM DamageTypes
UNION ALL
SELECT 
    'Warehouses',
    COUNT(*)
FROM Warehouses
UNION ALL
SELECT 
    'ShippingCompanies',
    COUNT(*)
FROM ShippingCompanies;

-- 移行結果の最終確認
SELECT 
    'TroubleType' as FieldName,
    COUNT(*) as TotalRecords,
    COUNT(TroubleTypeId) as MigratedRecords,
    COUNT(*) - COUNT(TroubleTypeId) as UnmigratedRecords
FROM Incidents
UNION ALL
SELECT 
    'DamageType',
    COUNT(*),
    COUNT(DamageTypeId),
    COUNT(*) - COUNT(DamageTypeId)
FROM Incidents
UNION ALL
SELECT 
    'Warehouse',
    COUNT(*),
    COUNT(WarehouseId),
    COUNT(*) - COUNT(WarehouseId)
FROM Incidents
UNION ALL
SELECT 
    'ShippingCompany',
    COUNT(*),
    COUNT(ShippingCompanyId),
    COUNT(*) - COUNT(ShippingCompanyId)
FROM Incidents;
```

---

## 6. ロールバック手順

### 6.1 マイグレーションのロールバック
```bash
# 本番環境でマイグレーションをロールバック
dotnet ef database update 20250825022322_CreateDatabaseSchema --startup-project ../LogisticsTroubleManagement.API

# 確認
dotnet ef migrations list --startup-project ../LogisticsTroubleManagement.API
```

### 6.2 データベースの完全復元
```sql
-- 緊急時のみ実行
-- アプリケーションを停止してから実行

-- 既存の接続を強制切断
ALTER DATABASE LogisticsTroubleManagement SET SINGLE_USER WITH ROLLBACK IMMEDIATE;

-- データベースの復元
RESTORE DATABASE LogisticsTroubleManagement 
FROM DISK = 'C:\Backup\LogisticsTroubleManagement_PreMasterMigration_YYYYMMDD_HHMMSS.bak'
WITH REPLACE;

-- マルチユーザーモードに戻す
ALTER DATABASE LogisticsTroubleManagement SET MULTI_USER;
```

---

## 7. 実行チェックリスト

### 7.1 事前準備
- [ ] 本番環境のバックアップ取得完了
- [ ] メンテナンス時間の確保（30分）
- [ ] ロールバック手順の準備完了
- [ ] 開発チームの待機体制完了
- [ ] 緊急連絡体制の確認完了

### 7.2 マイグレーション適用
- [ ] 開発環境でのマイグレーション作成完了
- [ ] マイグレーションファイルの本番環境配置完了
- [ ] 本番環境でのマイグレーション適用完了
- [ ] マイグレーション履歴の確認完了

### 7.3 データ移行
- [ ] 07_InsertMasterData.sql 実行完了
- [ ] 08_UpdateIncidentsTable.sql 実行完了
- [ ] 各ステップでの確認完了

### 7.4 最終確認
- [ ] マイグレーション履歴の整合性確認完了
- [ ] テーブル構造の確認完了
- [ ] 外部キー制約の確認完了
- [ ] データ整合性の確認完了
- [ ] アプリケーションの動作確認完了

---

## 8. 実行時間の目安

| 作業項目 | 予想時間 | 備考 |
|---------|---------|------|
| バックアップ取得 | 2-3分 | データ量による |
| マイグレーション適用 | 2-3分 | 新規テーブル作成 |
| マスタデータ挿入 | 30秒 | 初期データ挿入 |
| Incidentsテーブル更新 | 5-10分 | データ量による |
| 確認作業 | 3-5分 | 各項目の検証 |
| **合計** | **15-20分** | **余裕を持って30分確保** |

---

## 9. リスク要因と対策

### 9.1 高リスク項目

#### マイグレーション適用の失敗
- **リスク**: データベーススキーマの不整合
- **対策**: 事前バックアップ、段階的な適用

#### データ移行の失敗
- **リスク**: 既存データの消失・不整合
- **対策**: 移行前後の確認、ロールバック手順

#### マイグレーション履歴の不整合
- **リスク**: Entity Frameworkの動作異常
- **対策**: 手動更新、履歴の整合性確認

### 9.2 対策

#### 技術的対策
- 各ステップでの確認作業
- エラー発生時の即座停止
- ロールバック手順の準備
- マイグレーション履歴の整合性確保

#### 運用対策
- メンテナンス時間の十分な確保
- 開発チームの待機体制
- 緊急時の連絡体制
- 段階的な適用と確認

---

## 10. トラブルシューティング

### 10.1 よくある問題と解決方法

#### 問題1: マイグレーション適用時のエラー
```
エラー内容: 
- "Unable to resolve service for type 'Microsoft.EntityFrameworkCore.DbContextOptions'"
- "The object 'DF__Incidents__Troub__5AEE82B9' is dependent on column 'TroubleType'"

解決方法: 
1. バックアップから復元
2. マイグレーションファイルの内容確認
3. 必要に応じて手動でマイグレーション履歴を更新
4. 依存関係の確認と削除
```

#### 問題2: データ移行時の外部キー制約エラー
```
エラー内容:
- "The INSERT statement conflicted with the FOREIGN KEY constraint"
- "Invalid column name 'DamageTypeId'"

解決方法:
1. 移行スクリプトの実行順序確認
2. マスタデータの存在確認
3. データの整合性確認
4. 外部キー制約の一時的な無効化
```

#### 問題3: マイグレーション履歴の不整合
```
エラー内容:
- "Migration 'YYYYMMDDHHMMSS_CreateMasterTablesOnly' was not applied to the database"

解決方法:
1. __EFMigrationsHistoryテーブルの内容確認
2. 手動での履歴更新
3. 必要に応じてデータベースの再構築
```

### 10.2 緊急時の対応

#### 即座に停止すべき状況
- データ移行中にエラーが発生
- 外部キー制約エラーが連続発生
- データの整合性が確認できない
- アプリケーションが正常に動作しない

#### 緊急時の連絡先
- システム管理者: [連絡先]
- 開発チームリーダー: [連絡先]
- 運用チーム: [連絡先]

---

## 11. 事後作業

### 11.1 ログの確認
```sql
-- SQL Serverエラーログの確認
EXEC xp_readerrorlog;

-- アプリケーションログの確認
-- 本番環境のログファイルを確認
```

### 11.2 パフォーマンスの確認
```sql
-- テーブルの統計情報更新
UPDATE STATISTICS Incidents;
UPDATE STATISTICS TroubleTypes;
UPDATE STATISTICS DamageTypes;
UPDATE STATISTICS Warehouses;
UPDATE STATISTICS ShippingCompanies;

-- インデックスの再構築（必要に応じて）
ALTER INDEX ALL ON Incidents REBUILD;
```

### 11.3 監視体制の確認
- アプリケーションの動作監視
- データベースのパフォーマンス監視
- エラーログの監視
- ユーザーからの問題報告の確認

---

## 12. 完了報告

### 12.1 完了確認項目
- [ ] すべてのスクリプトが正常に実行された
- [ ] データの整合性が確認された
- [ ] アプリケーションが正常に動作する
- [ ] ユーザーが正常に操作できる
- [ ] パフォーマンスに問題がない

### 12.2 完了報告書
以下の内容を含む完了報告書を作成：
- 実行日時
- 実行者
- 実行結果
- 発生した問題と対応内容
- 今後の注意点
- 次回の改善点

---

## 13. 参考資料

### 13.1 関連ドキュメント
- [マスタ管理機能拡張_変更概要仕様書](./マスタ管理機能拡張_変更概要仕様書.md)
- [テーブル仕様書](./テーブル仕様書.md)
- [API仕様書](./API仕様書.md)
- [ER図](./ER図.md)

### 13.2 技術仕様
- Entity Framework Core 9.0.8
- SQL Server 2019以降
- ASP.NET Core 8.0 LTS
- .NET 8.0 LTS

---

## 14. 更新履歴

| 日付 | 更新者 | 更新内容 | バージョン |
|------|--------|----------|------------|
| 2025-08-30 | システム開発チーム | 初版作成 | 1.0.0 |

---

## 15. 連絡先

### 15.1 技術的な質問・問題
- 開発チーム: [連絡先]
- システム管理者: [連絡先]

### 15.2 運用に関する質問・問題
- 運用チーム: [連絡先]
- プロジェクトマネージャー: [連絡先]

---

**注意**: この手順書は本番環境での適用を前提としています。開発環境やテスト環境での適用時は、適宜内容を調整してください。
