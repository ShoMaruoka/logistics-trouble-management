# 物流トラブル管理システム マスタ管理機能拡張 変更概要仕様書

**作成日**: 2025-08-28  
**作成者**: システム開発チーム  
**バージョン**: 1.0  
**優先度**: 高

## 1. 概要

### 1.1 目的
Incidentsテーブルで管理している以下の4項目について、現在のEnumベースの管理からマスタテーブルによる管理に変更し、システムの拡張性を向上させる。

### 1.2 対象項目
- **トラブル種類** (TroubleType)
- **損傷種類** (DamageType)  
- **出荷元倉庫** (Warehouse)
- **運送会社** (ShippingCompany)

### 1.3 変更の背景
- 現在はEnumで固定値として管理されており、新規追加・変更・削除が困難
- ビジネス要件の変更に対応できない
- 多言語対応や説明文の管理ができない
- 履歴管理や監査ができない

## 2. 現状分析

### 2.1 現在の実装
```csharp
// 現在はEnumで管理
public enum TroubleType
{
    ProductTrouble,      // 商品トラブル
    DeliveryTrouble,     // 配送トラブル
    SystemTrouble,       // システムトラブル
    // ... その他
}

public enum DamageType
{
    None,                // 該当なし
    WrongShipment,       // 誤出荷
    Lost,                // 紛失
    // ... その他
}
```

### 2.2 現在の制約
- 新規値の追加にはコード変更が必要
- 値の説明文はコード内にハードコーディング
- 多言語対応が困難
- 履歴管理ができない
- システム再起動が必要

## 3. 新設計

### 3.1 個別テーブル設計

#### 3.1.1 TroubleTypesテーブル（トラブル種類マスタ）
```sql
CREATE TABLE TroubleTypes (
    Id INT PRIMARY KEY IDENTITY(1,1),           -- 自動採番（1から開始）
    Name NVARCHAR(100) NOT NULL,                -- 表示名（商品トラブル等）
    Description NVARCHAR(500) NULL,             -- 説明文
    Color NVARCHAR(7) NOT NULL DEFAULT '#3B82F6', -- 表示色（HEX）
    SortOrder INT NOT NULL DEFAULT 0,           -- 表示順序
    IsActive BIT NOT NULL DEFAULT 1,            -- 有効フラグ
    CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    UpdatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE()
);

-- インデックス
CREATE INDEX IX_TroubleTypes_IsActive_SortOrder ON TroubleTypes (IsActive, SortOrder);
CREATE INDEX IX_TroubleTypes_Name ON TroubleTypes (Name);
```

#### 3.1.2 DamageTypesテーブル（損傷種類マスタ）
```sql
CREATE TABLE DamageTypes (
    Id INT PRIMARY KEY IDENTITY(1,1),           -- 自動採番（1から開始）
    Name NVARCHAR(100) NOT NULL,                -- 表示名（該当なし、誤出荷等）
    Description NVARCHAR(500) NULL,             -- 説明文
    Category NVARCHAR(50) NOT NULL DEFAULT 'General', -- カテゴリ（General, Delivery, Product等）
    SortOrder INT NOT NULL DEFAULT 0,           -- 表示順序
    IsActive BIT NOT NULL DEFAULT 1,            -- 有効フラグ
    CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    UpdatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE()
);

-- インデックス
CREATE INDEX IX_DamageTypes_IsActive_SortOrder ON DamageTypes (IsActive, SortOrder);
CREATE INDEX IX_DamageTypes_Category ON DamageTypes (Category);
CREATE INDEX IX_DamageTypes_Name ON DamageTypes (Name);
```

#### 3.1.3 Warehousesテーブル（出荷元倉庫マスタ）
```sql
CREATE TABLE Warehouses (
    Id INT PRIMARY KEY IDENTITY(1,1),           -- 自動採番（1から開始）
    Name NVARCHAR(100) NOT NULL,                -- 表示名（該当なし、A倉庫等）
    Description NVARCHAR(500) NULL,             -- 説明文
    Location NVARCHAR(200) NULL,                -- 所在地
    ContactInfo NVARCHAR(200) NULL,             -- 連絡先情報
    SortOrder INT NOT NULL DEFAULT 0,           -- 表示順序
    IsActive BIT NOT NULL DEFAULT 1,            -- 有効フラグ
    CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    UpdatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE()
);

-- インデックス
CREATE INDEX IX_Warehouses_IsActive_SortOrder ON Warehouses (IsActive, SortOrder);
CREATE INDEX IX_Warehouses_Name ON Warehouses (Name);
```

#### 3.1.4 ShippingCompaniesテーブル（運送会社マスタ）
```sql
CREATE TABLE ShippingCompanies (
    Id INT PRIMARY KEY IDENTITY(1,1),           -- 自動採番（1から開始）
    Name NVARCHAR(100) NOT NULL,                -- 表示名（該当なし、庫内等）
    Description NVARCHAR(500) NULL,             -- 説明文
    CompanyType NVARCHAR(50) NOT NULL DEFAULT 'External', -- 会社種別（Internal, External, Charter）
    ContactInfo NVARCHAR(200) NULL,             -- 連絡先情報
    SortOrder INT NOT NULL DEFAULT 0,           -- 表示順序
    IsActive BIT NOT NULL DEFAULT 1,            -- 有効フラグ
    CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    UpdatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE()
);

-- インデックス
CREATE INDEX IX_ShippingCompanies_IsActive_SortOrder ON ShippingCompanies (IsActive, SortOrder);
CREATE INDEX IX_ShippingCompanies_CompanyType ON ShippingCompanies (CompanyType);
CREATE INDEX IX_ShippingCompanies_Name ON ShippingCompanies (Name);
```

### 3.2 既存Enum値のマスタデータ投入

#### 3.2.1 TroubleTypes初期データ
```sql
INSERT INTO TroubleTypes (Name, Description, Color, SortOrder) VALUES
('商品トラブル', '商品自体に関するトラブル', '#EF4444', 1),
('配送トラブル', '配送プロセスに関するトラブル', '#F97316', 2),
('システムトラブル', 'システム・ITに関するトラブル', '#8B5CF6', 3),
('設備トラブル', '設備・機械に関するトラブル', '#06B6D4', 4),
('品質トラブル', '品質に関するトラブル', '#10B981', 5),
('物流トラブル', '物流プロセスに関するトラブル', '#3B82F6', 6),
('管理トラブル', '管理・運営に関するトラブル', '#F59E0B', 7),
('安全トラブル', '安全に関するトラブル', '#84CC16', 8),
('環境トラブル', '環境に関するトラブル', '#22C55E', 9),
('その他のトラブル', 'その他のカテゴリに該当しないトラブル', '#6B7280', 10);
```

#### 3.2.2 DamageTypes初期データ
```sql
INSERT INTO DamageTypes (Name, Description, Category, SortOrder) VALUES
('該当なし', '損傷・問題なし', 'General', 1),
('誤出荷', '誤った商品の出荷', 'Product', 2),
('早着・延着', '配送の時間に関する問題', 'Delivery', 3),
('紛失', '商品の紛失', 'Product', 4),
('誤配送', '誤った場所への配送', 'Delivery', 5),
('破損・汚損', '商品の破損・汚損', 'Product', 6),
('その他の配送ミス', 'その他の配送に関する問題', 'Delivery', 7),
('その他の商品事故', 'その他の商品に関する問題', 'Product', 8);
```

#### 3.2.3 Warehouses初期データ
```sql
INSERT INTO Warehouses (Name, Description, Location, SortOrder) VALUES
('該当なし', '倉庫に関係ない', NULL, 1),
('A倉庫', 'A倉庫からの出荷', '東京都○○区', 2),
('B倉庫', 'B倉庫からの出荷', '大阪府○○市', 3),
('C倉庫', 'C倉庫からの出荷', '愛知県○○市', 4);
```

#### 3.2.4 ShippingCompanies初期データ
```sql
INSERT INTO ShippingCompanies (Name, Description, CompanyType, SortOrder) VALUES
('該当なし', '運送会社に関係ない', 'Internal', 1),
('庫内', '自社庫内での処理', 'Internal', 2),
('チャーター', 'チャーター便の利用', 'External', 3),
('A運輸', 'A運輸会社の利用', 'External', 4),
('B急便', 'B急便の利用', 'External', 5);
```

## 4. エンティティ設計

### 4.1 マスタデータエンティティ

#### 4.1.1 TroubleTypeエンティティ
```csharp
public class TroubleType : BaseEntity
{
    public string Name { get; private set; }
    public string? Description { get; private set; }
    public string Color { get; private set; }
    public int SortOrder { get; private set; }
    public bool IsActive { get; private set; }

    // Navigation properties
    public virtual ICollection<Incident> Incidents { get; private set; } = new List<Incident>();

    private TroubleType() { }

    public TroubleType(string name, string? description = null, 
        string color = "#3B82F6", int sortOrder = 0)
    {
        Name = name ?? throw new ArgumentNullException(nameof(name));
        Description = description;
        Color = color;
        SortOrder = sortOrder;
        IsActive = true;
        CreatedAt = DateTime.UtcNow;
        UpdatedAt = DateTime.UtcNow;
    }

    public void Update(string name, string? description, string color, int sortOrder)
    {
        Name = name ?? throw new ArgumentNullException(nameof(name));
        Description = description;
        Color = color;
        SortOrder = sortOrder;
        UpdatedAt = DateTime.UtcNow;
    }

    public void SetActive(bool isActive)
    {
        IsActive = isActive;
        UpdatedAt = DateTime.UtcNow;
    }
}
```

#### 4.1.2 DamageTypeエンティティ
```csharp
public class DamageType : BaseEntity
{
    public string Name { get; private set; }
    public string? Description { get; private set; }
    public string Category { get; private set; }
    public int SortOrder { get; private set; }
    public bool IsActive { get; private set; }

    // Navigation properties
    public virtual ICollection<Incident> Incidents { get; private set; } = new List<Incident>();

    private DamageType() { }

    public DamageType(string name, string? description = null, 
        string category = "General", int sortOrder = 0)
    {
        Name = name ?? throw new ArgumentNullException(nameof(name));
        Description = description;
        Category = category;
        SortOrder = sortOrder;
        IsActive = true;
        CreatedAt = DateTime.UtcNow;
        UpdatedAt = DateTime.UtcNow;
    }

    public void Update(string name, string? description, string category, int sortOrder)
    {
        Name = name ?? throw new ArgumentNullException(nameof(name));
        Description = description;
        Category = category;
        SortOrder = sortOrder;
        UpdatedAt = DateTime.UtcNow;
    }

    public void SetActive(bool isActive)
    {
        IsActive = isActive;
        UpdatedAt = DateTime.UtcNow;
    }
}
```

#### 4.1.3 Warehouseエンティティ
```csharp
public class Warehouse : BaseEntity
{
    public string Name { get; private set; }
    public string? Description { get; private set; }
    public string? Location { get; private set; }
    public string? ContactInfo { get; private set; }
    public int SortOrder { get; private set; }
    public bool IsActive { get; private set; }

    // Navigation properties
    public virtual ICollection<Incident> Incidents { get; private set; } = new List<Incident>();

    private Warehouse() { }

    public Warehouse(string name, string? description = null, 
        string? location = null, string? contactInfo = null, int sortOrder = 0)
    {
        Name = name ?? throw new ArgumentNullException(nameof(name));
        Description = description;
        Location = location;
        ContactInfo = contactInfo;
        SortOrder = sortOrder;
        IsActive = true;
        CreatedAt = DateTime.UtcNow;
        UpdatedAt = DateTime.UtcNow;
    }

    public void Update(string name, string? description, string? location, 
        string? contactInfo, int sortOrder)
    {
        Name = name ?? throw new ArgumentNullException(nameof(name));
        Description = description;
        Location = location;
        ContactInfo = contactInfo;
        SortOrder = sortOrder;
        UpdatedAt = DateTime.UtcNow;
    }

    public void SetActive(bool isActive)
    {
        IsActive = isActive;
        UpdatedAt = DateTime.UtcNow;
    }
}
```

#### 4.1.4 ShippingCompanyエンティティ
```csharp
public class ShippingCompany : BaseEntity
{
    public string Name { get; private set; }
    public string? Description { get; private set; }
    public string CompanyType { get; private set; }
    public string? ContactInfo { get; private set; }
    public int SortOrder { get; private set; }
    public bool IsActive { get; private set; }

    // Navigation properties
    public virtual ICollection<Incident> Incidents { get; private set; } = new List<Incident>();

    private ShippingCompany() { }

    public ShippingCompany(string name, string? description = null, 
        string companyType = "External", string? contactInfo = null, int sortOrder = 0)
    {
        Name = name ?? throw new ArgumentNullException(nameof(name));
        Description = description;
        CompanyType = companyType;
        ContactInfo = contactInfo;
        SortOrder = sortOrder;
        IsActive = true;
        CreatedAt = DateTime.UtcNow;
        UpdatedAt = DateTime.UtcNow;
    }

    public void Update(string name, string? description, string companyType, 
        string? contactInfo, int sortOrder)
    {
        Name = name ?? throw new ArgumentNullException(nameof(name));
        Description = description;
        CompanyType = companyType;
        ContactInfo = contactInfo;
        SortOrder = sortOrder;
        UpdatedAt = DateTime.UtcNow;
    }

    public void SetActive(bool isActive)
    {
        IsActive = isActive;
        UpdatedAt = DateTime.UtcNow;
    }
}
```

### 4.2 Incidentエンティティの更新

```csharp
public class Incident : BaseEntity
{
    // 既存のEnumプロパティをマスタIDに変更
    public int TroubleTypeId { get; private set; }
    public int DamageTypeId { get; private set; }
    public int WarehouseId { get; private set; }
    public int ShippingCompanyId { get; private set; }

    // Navigation properties
    public virtual TroubleType TroubleType { get; private set; } = null!;
    public virtual DamageType DamageType { get; private set; } = null!;
    public virtual Warehouse Warehouse { get; private set; } = null!;
    public virtual ShippingCompany ShippingCompany { get; private set; } = null!;

    // 既存のメソッドを更新
    public void UpdateLogisticsDetails(int troubleTypeId, int damageTypeId, 
        int warehouseId, int shippingCompanyId)
    {
        TroubleTypeId = troubleTypeId;
        DamageTypeId = damageTypeId;
        WarehouseId = warehouseId;
        ShippingCompanyId = shippingCompanyId;
        UpdatedAt = DateTime.UtcNow;
    }

    // コンストラクタも更新
    public Incident(string title, string description, string category, int reportedById, 
        int troubleTypeId, int damageTypeId, int warehouseId, int shippingCompanyId, 
        DateTime occurrenceDate, Priority priority = Priority.Medium,
        string incidentDetails = "", int totalShipments = 0, int defectiveItems = 0,
        string occurrenceLocation = "", string summary = "",
        string cause = "", string preventionMeasures = "")
    {
        Title = title ?? throw new ArgumentNullException(nameof(title));
        Description = description ?? throw new ArgumentNullException(nameof(description));
        Category = category ?? throw new ArgumentNullException(nameof(category));
        ReportedById = reportedById;
        TroubleTypeId = troubleTypeId;
        DamageTypeId = damageTypeId;
        WarehouseId = warehouseId;
        ShippingCompanyId = shippingCompanyId;
        EffectivenessStatus = EffectivenessStatus.NotImplemented;
        Priority = priority;
        Status = IncidentStatus.Open;
        
        // 新規追加項目
        IncidentDetails = incidentDetails;
        TotalShipments = totalShipments;
        DefectiveItems = defectiveItems;
        OccurrenceDate = occurrenceDate;
        OccurrenceLocation = occurrenceLocation;
        Summary = summary;
        Cause = cause;
        PreventionMeasures = preventionMeasures;
        
        ReportedDate = DateTime.UtcNow;
        CreatedAt = DateTime.UtcNow;
        UpdatedAt = DateTime.UtcNow;
    }
}
```

## 5. DTO設計

### 5.1 マスタデータDTO

#### 5.1.1 TroubleTypeDto
```csharp
public class TroubleTypeDto
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string Color { get; set; } = "#3B82F6";
    public int SortOrder { get; set; }
    public bool IsActive { get; set; }
}

public class CreateTroubleTypeDto
{
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string Color { get; set; } = "#3B82F6";
    public int SortOrder { get; set; }
}

public class UpdateTroubleTypeDto
{
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string Color { get; set; } = "#3B82F6";
    public int SortOrder { get; set; }
    public bool IsActive { get; set; }
}
```

#### 5.1.2 DamageTypeDto
```csharp
public class DamageTypeDto
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string Category { get; set; } = "General";
    public int SortOrder { get; set; }
    public bool IsActive { get; set; }
}

public class CreateDamageTypeDto
{
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string Category { get; set; } = "General";
    public int SortOrder { get; set; }
}

public class UpdateDamageTypeDto
{
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string Category { get; set; } = "General";
    public int SortOrder { get; set; }
    public bool IsActive { get; set; }
}
```

#### 5.1.3 WarehouseDto
```csharp
public class WarehouseDto
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string? Location { get; set; }
    public string? ContactInfo { get; set; }
    public int SortOrder { get; set; }
    public bool IsActive { get; set; }
}

public class CreateWarehouseDto
{
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string? Location { get; set; }
    public string? ContactInfo { get; set; }
    public int SortOrder { get; set; }
}

public class UpdateWarehouseDto
{
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string? Location { get; set; }
    public string? ContactInfo { get; set; }
    public int SortOrder { get; set; }
    public bool IsActive { get; set; }
}
```

#### 5.1.4 ShippingCompanyDto
```csharp
public class ShippingCompanyDto
{
    public int Id { get; set; }
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string CompanyType { get; set; } = "External";
    public string? ContactInfo { get; set; }
    public int SortOrder { get; set; }
    public bool IsActive { get; set; }
}

public class CreateShippingCompanyDto
{
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string CompanyType { get; set; } = "External";
    public string? ContactInfo { get; set; }
    public int SortOrder { get; set; }
}

public class UpdateShippingCompanyDto
{
    public string Name { get; set; } = string.Empty;
    public string? Description { get; set; }
    public string CompanyType { get; set; } = "External";
    public string? ContactInfo { get; set; }
    public int SortOrder { get; set; }
    public bool IsActive { get; set; }
}
```

### 5.2 IncidentDtoの更新

```csharp
public class IncidentDto
{
    // 既存のEnumプロパティをマスタIDに変更
    public int TroubleTypeId { get; set; }
    public int DamageTypeId { get; set; }
    public int WarehouseId { get; set; }
    public int ShippingCompanyId { get; set; }

    // 表示用のマスタ情報
    public string TroubleTypeName { get; set; } = string.Empty;
    public string TroubleTypeColor { get; set; } = "#3B82F6";
    public string DamageTypeName { get; set; } = string.Empty;
    public string WarehouseName { get; set; } = string.Empty;
    public string ShippingCompanyName { get; set; } = string.Empty;

    // 既存のプロパティ
    public int Id { get; set; }
    public string Title { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public string Status { get; set; } = string.Empty;
    public string Priority { get; set; } = string.Empty;
    public string Category { get; set; } = string.Empty;
    // ... その他のプロパティ
}
```

## 6. フロントエンド設計

### 6.1 マスタ管理画面の共通機能

#### 6.1.1 一覧表示
- マスタデータの一覧表示
- ソート機能（SortOrder、Name等）
- フィルタ機能（IsActive等）
- ページネーション機能

#### 6.1.2 新規作成・編集フォーム
- 新規作成時はIDを指定しない（システムが自動付与）
- 編集時は既存レコードのIDを使用
- バリデーション機能
- カラーピッカー（トラブル種類用）

#### 6.1.3 削除・無効化
- 物理削除ではなく論理削除（isActive = false）
- データの整合性を保つ

### 6.2 各マスタ管理画面

#### 6.2.1 トラブル種類管理画面
- 名称、説明、色、表示順序、有効フラグの管理
- カラーピッカーによる色選択
- 色による視覚的な分類

#### 6.2.2 損傷種類管理画面
- 名称、説明、カテゴリ、表示順序、有効フラグの管理
- カテゴリ別の分類管理
- ドロップダウンによるカテゴリ選択

#### 6.2.3 出荷元倉庫管理画面
- 名称、説明、所在地、連絡先、表示順序、有効フラグの管理
- 所在地・連絡先情報の管理
- 倉庫の詳細情報管理

#### 6.2.4 運送会社管理画面
- 名称、説明、会社種別、連絡先、表示順序、有効フラグの管理
- 会社種別の分類管理
- ドロップダウンによる会社種別選択

## 7. データベースマイグレーション

### 7.1 移行手順

1. **マスタテーブルの作成**
   - 4つのマスタテーブルを作成
   - 初期データを投入

2. **Incidentsテーブルの更新**
   - 既存のEnumカラムを一時的に保持
   - 新しいマスタIDカラムを追加
   - 既存データを移行（Nameベースでマッピング）
   - 古いEnumカラムを削除

3. **外部キー制約の追加**
   - マスタテーブルへの外部キー制約を設定

### 7.2 移行スクリプト例

```sql
-- 1. マスタテーブルの作成（上記のCREATE TABLE文）

-- 2. 初期データの投入（上記のINSERT文）

-- 3. Incidentsテーブルの更新
ALTER TABLE Incidents ADD TroubleTypeId INT NULL;
ALTER TABLE Incidents ADD DamageTypeId INT NULL;
ALTER TABLE Incidents ADD WarehouseId INT NULL;
ALTER TABLE Incidents ADD ShippingCompanyId INT NULL;

-- 4. 既存データの移行（Nameベースでマッピング）
UPDATE Incidents SET TroubleTypeId = (SELECT Id FROM TroubleTypes WHERE Name = '商品トラブル') WHERE TroubleType = 0;
UPDATE Incidents SET TroubleTypeId = (SELECT Id FROM TroubleTypes WHERE Name = '配送トラブル') WHERE TroubleType = 1;
-- ... 他の値も同様に移行

UPDATE Incidents SET DamageTypeId = (SELECT Id FROM DamageTypes WHERE Name = '該当なし') WHERE DamageType = 0;
UPDATE Incidents SET DamageTypeId = (SELECT Id FROM DamageTypes WHERE Name = '誤出荷') WHERE DamageType = 1;
-- ... 他の値も同様に移行

-- 5. 外部キー制約の追加
ALTER TABLE Incidents ADD CONSTRAINT FK_Incidents_TroubleTypes 
    FOREIGN KEY (TroubleTypeId) REFERENCES TroubleTypes(Id);
ALTER TABLE Incidents ADD CONSTRAINT FK_Incidents_DamageTypes 
    FOREIGN KEY (DamageTypeId) REFERENCES DamageTypes(Id);
ALTER TABLE Incidents ADD CONSTRAINT FK_Incidents_Warehouses 
    FOREIGN KEY (WarehouseId) REFERENCES Warehouses(Id);
ALTER TABLE Incidents ADD CONSTRAINT FK_Incidents_ShippingCompanies 
    FOREIGN KEY (ShippingCompanyId) REFERENCES ShippingCompanies(Id);

-- 6. 古いEnumカラムの削除
ALTER TABLE Incidents DROP COLUMN TroubleType;
ALTER TABLE Incidents DROP COLUMN DamageType;
ALTER TABLE Incidents DROP COLUMN Warehouse;
ALTER TABLE Incidents DROP COLUMN ShippingCompany;

-- 7. 新しいカラムをNOT NULLに変更
ALTER TABLE Incidents ALTER COLUMN TroubleTypeId INT NOT NULL;
ALTER TABLE Incidents ALTER COLUMN DamageTypeId INT NOT NULL;
ALTER TABLE Incidents ALTER COLUMN WarehouseId INT NOT NULL;
ALTER TABLE Incidents ALTER COLUMN ShippingCompanyId INT NOT NULL;
```

## 8. 実装計画

### 8.1 フェーズ1: データベース設計・作成
- [ ] マスタテーブルの作成
- [ ] 既存Enum値のマスタデータ投入
- [ ] インデックス・制約の設定

### 8.2 フェーズ2: バックエンド実装
- [ ] マスタデータエンティティの作成
- [ ] マスタデータリポジトリの実装
- [ ] マスタ管理APIの実装
- [ ] Incidentエンティティの更新
- [ ] データベースマイグレーションの作成

### 8.3 フェーズ3: フロントエンド実装
- [ ] 型定義の更新
- [ ] マスタ管理画面の実装
- [ ] インシデント登録・編集フォームの更新
- [ ] 一覧表示の更新

### 8.4 フェーズ4: データ移行・テスト
- [ ] 既存データの移行処理
- [ ] 動作確認・テスト
- [ ] パフォーマンステスト

## 9. 技術的考慮事項

### 9.1 パフォーマンス
- マスタデータのキャッシュ機能
- 適切なインデックス設計
- N+1問題の回避

### 9.2 互換性
- 既存APIの互換性維持
- 段階的な移行によるリスク最小化
- ロールバック機能の準備

### 9.3 セキュリティ
- マスタデータの更新権限管理
- 監査ログの記録
- データ整合性の確保

## 10. リスクと対策

### 10.1 主要リスク
1. **データ移行時の整合性問題**
   - 対策: 段階的な移行とロールバック機能の準備

2. **パフォーマンスへの影響**
   - 対策: 適切なインデックス設計とキャッシュ機能の実装

3. **フロントエンド・バックエンド間の不整合**
   - 対策: 型定義の統一とAPI仕様の明確化

### 10.2 対策
- 十分なテスト環境での検証
- 段階的な実装とデプロイ
- 監視・ログ機能の強化

## 11. 期待される効果

### 11.1 短期的効果
- マスタデータの柔軟な管理
- 新規値の追加・変更の容易化
- 説明文の管理改善

### 11.2 長期的効果
- システムの拡張性向上
- 多言語対応の実現可能性
- ビジネス要件変更への対応力向上
- 履歴管理・監査機能の実現

## 12. 個別テーブルの利点

### 12.1 管理の容易さ
- 各マスタの特性に応じたカラム設計が可能
- カテゴリ別の管理が容易
- 個別のビジネスルールを適用可能

### 12.2 拡張性
- 各マスタに固有の属性を追加可能
- トラブル種類に色情報、損傷種類にカテゴリ等
- 将来的な要件変更への対応が容易

### 12.3 パフォーマンス
- 各マスタテーブルに最適化されたインデックス
- 必要なマスタのみを取得可能
- 結合クエリの最適化

### 12.4 保守性
- 各マスタの独立した管理
- 影響範囲の限定
- テストの容易さ

## 13. IDの自動付与について

### 13.1 バックエンド側
- SQL Serverの`IDENTITY(1,1)`設定により自動採番
- 新規レコード作成時に1から開始、1ずつ増加

### 13.2 フロントエンド側
- **新規作成時**: IDは指定不要（空または0）
- **更新時**: 既存レコードのIDを使用
- **削除時**: 既存レコードのIDを使用

### 13.3 ユーザビリティの向上
- ユーザーはIDを意識することなく操作可能
- システムが自動的にIDを管理
- データの整合性を保証

---

**文書履歴**

| 日付 | バージョン | 変更内容 | 変更者 |
|------|------------|----------|--------|
| 2025-08-28 | 1.0 | 初版作成 | システム開発チーム |

---

**承認**

| 役職 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| プロジェクトマネージャー | | | |
| システム設計者 | | | |
| 開発責任者 | | | |
