# 物流トラブル管理システム テーブル仕様書

**作成日**: 2025-08-27  
**作成者**: システム開発チーム  
**バージョン**: 1.0

## 概要

本ドキュメントは、物流トラブル管理システムで使用されるデータベーステーブルの詳細仕様を定義します。各テーブルの目的、構造、制約、リレーションシップについて説明します。

## テーブル一覧

1. [Users](#users) - ユーザー管理テーブル
2. [Incidents](#incidents) - インシデント管理テーブル
3. [Attachments](#attachments) - 添付ファイル管理テーブル
4. [AuditLogs](#auditlogs) - 監査ログテーブル
5. [Effectiveness](#effectiveness) - 有効性測定テーブル

## 共通項目

すべてのテーブルに以下の共通項目が含まれます：

| 項目名 | データ型 | 制約 | 説明 |
|--------|----------|------|------|
| Id | int | PRIMARY KEY, IDENTITY(1,1) | 主キー（自動採番） |
| CreatedAt | datetime2 | NOT NULL, DEFAULT: GETUTCDATE() | 作成日時（UTC） |
| UpdatedAt | datetime2 | NOT NULL, DEFAULT: GETUTCDATE() | 更新日時（UTC） |

---

## Users

### テーブル概要
システムユーザーの情報を管理するテーブルです。ユーザーの認証、権限、プロフィール情報を格納します。

### テーブル構造

| 項目名 | データ型 | 制約 | 説明 |
|--------|----------|------|------|
| Id | int | PRIMARY KEY, IDENTITY(1,1) | 主キー（自動採番） |
| Username | nvarchar(50) | NOT NULL, UNIQUE | ユーザー名（ログインID） |
| Email | nvarchar(100) | NOT NULL, UNIQUE | メールアドレス |
| FirstName | nvarchar(50) | NOT NULL | 名 |
| LastName | nvarchar(50) | NOT NULL | 姓 |
| Role | int | NOT NULL | ユーザーロール（1:User, 2:Manager, 3:Admin） |
| IsActive | bit | NOT NULL, DEFAULT: true | アクティブフラグ |
| PhoneNumber | nvarchar(20) | NULL | 電話番号 |
| CreatedAt | datetime2 | NOT NULL, DEFAULT: GETUTCDATE() | 作成日時（UTC） |
| UpdatedAt | datetime2 | NOT NULL, DEFAULT: GETUTCDATE() | 更新日時（UTC） |

### インデックス

| インデックス名 | 対象カラム | 種類 | 説明 |
|----------------|-------------|------|------|
| IX_Users_Email | Email | UNIQUE | メールアドレスの一意性確保 |
| IX_Users_Username | Username | UNIQUE | ユーザー名の一意性確保 |

### ビジネスルール

- ユーザー名とメールアドレスは一意である必要があります
- ユーザーロールは階層構造になっており、上位ロールは下位ロールの権限を継承します
- 非アクティブユーザーはログインできません

### 関連テーブル

- **ReportedIncidents**: ユーザーが報告したインシデント（1対多）
- **AssignedIncidents**: ユーザーに割り当てられたインシデント（1対多）
- **UploadedAttachments**: ユーザーがアップロードした添付ファイル（1対多）
- **AuditLogs**: ユーザーの操作ログ（1対多）
- **MeasuredEffectiveness**: ユーザーが測定した有効性（1対多）

---

## Incidents

### テーブル概要
物流トラブルのインシデント情報を管理するメインテーブルです。トラブルの詳細、状況、対応状況を追跡します。

### テーブル構造

| 項目名 | データ型 | 制約 | 説明 |
|--------|----------|------|------|
| Id | int | PRIMARY KEY, IDENTITY(1,1) | 主キー（自動採番） |
| Title | nvarchar(200) | NOT NULL | インシデントタイトル |
| Description | nvarchar(max) | NOT NULL | インシデントの詳細説明 |
| Status | int | NOT NULL | ステータス（1:Open, 2:InProgress, 3:Resolved, 4:Closed, 5:Cancelled） |
| Priority | int | NOT NULL | 優先度（1:Low, 2:Medium, 3:High, 4:Critical） |
| Category | nvarchar(50) | NOT NULL | カテゴリ |
| **TroubleType** | int | NOT NULL | トラブル種類（ProductTrouble, DeliveryTrouble, SystemTrouble等） |
| **DamageType** | int | NOT NULL | 損傷種類（None, WrongShipment, Lost等） |
| **Warehouse** | int | NOT NULL | 出荷元倉庫（None, WarehouseA, WarehouseB, WarehouseC） |
| **ShippingCompany** | int | NOT NULL | 運送会社（None, InHouse, Charter, ATransport, BExpress） |
| **EffectivenessStatus** | int | NOT NULL | 有効性確認ステータス（NotImplemented, Implemented） |
| **IncidentDetails** | nvarchar(max) | NOT NULL, DEFAULT: "" | 発生経緯の詳細 |
| **TotalShipments** | int | NOT NULL, DEFAULT: 0 | 出荷総数 |
| **DefectiveItems** | int | NOT NULL, DEFAULT: 0 | 不良品数 |
| **OccurrenceDate** | datetime2 | NOT NULL | トラブル発生日 |
| **OccurrenceLocation** | nvarchar(max) | NOT NULL, DEFAULT: "" | 発生場所 |
| **Summary** | nvarchar(max) | NOT NULL, DEFAULT: "" | 概要 |
| **Cause** | nvarchar(max) | NULL | 原因 |
| **PreventionMeasures** | nvarchar(max) | NULL | 再発防止策 |
| **EffectivenessDate** | datetime2 | NULL | 有効性確認日 |
| **EffectivenessComment** | nvarchar(max) | NOT NULL, DEFAULT: "" | 有効性確認コメント |
| ReportedById | int | NOT NULL | 報告者ID（Usersテーブル参照） |
| AssignedToId | int | NULL | 担当者ID（Usersテーブル参照） |
| ReportedDate | datetime2 | NOT NULL, DEFAULT: GETUTCDATE() | 報告日時 |
| ResolvedDate | datetime2 | NULL | 解決日時 |
| Resolution | nvarchar(max) | NULL | 解決内容 |
| CreatedAt | datetime2 | NOT NULL, DEFAULT: GETUTCDATE() | 作成日時（UTC） |
| UpdatedAt | datetime2 | NOT NULL, DEFAULT: GETUTCDATE() | 更新日時（UTC） |

**注**: 太字の項目は物流特化項目として後から追加された項目です。

### インデックス

| インデックス名 | 対象カラム | 種類 | 説明 |
|----------------|-------------|------|------|
| IX_Incidents_AssignedToId | AssignedToId | NON-UNIQUE | 担当者での検索高速化 |
| IX_Incidents_ReportedById | ReportedById | NON-UNIQUE | 報告者での検索高速化 |

### 外部キー制約

| 制約名 | 参照先 | カラム | 削除ルール |
|---------|---------|--------|------------|
| FK_Incidents_Users_AssignedToId | Users.Id | AssignedToId | SET NULL |
| FK_Incidents_Users_ReportedById | Users.Id | ReportedById | RESTRICT |

### ビジネスルール

- インシデントは必ず報告者が設定される必要があります
- ステータスが「Resolved」または「Closed」の場合のみ解決日時が設定されます
- 優先度は「Low」「Medium」「High」「Critical」の4段階で管理されます
- トラブル種類、損傷種類、倉庫、運送会社は物流特化の分類項目です
- 有効性確認ステータスは改善策の効果測定状況を管理します

### 関連テーブル

- **ReportedBy**: 報告者（Usersテーブル、多対1）
- **AssignedTo**: 担当者（Usersテーブル、多対1）
- **Attachments**: 添付ファイル（1対多）
- **AuditLogs**: 監査ログ（1対多）
- **Effectiveness**: 有効性測定（1対多）

---

## Attachments

### テーブル概要
インシデントに関連する添付ファイルの情報を管理するテーブルです。ファイルのメタデータとストレージパスを格納します。

### テーブル構造

| 項目名 | データ型 | 制約 | 説明 |
|--------|----------|------|------|
| Id | int | PRIMARY KEY, IDENTITY(1,1) | 主キー（自動採番） |
| IncidentId | int | NOT NULL | インシデントID（Incidentsテーブル参照） |
| FileName | nvarchar(255) | NOT NULL | ファイル名 |
| FilePath | nvarchar(500) | NOT NULL | ファイルパス（ストレージ内のパス） |
| FileSize | bigint | NOT NULL | ファイルサイズ（バイト） |
| ContentType | nvarchar(100) | NOT NULL | MIMEタイプ |
| UploadedById | int | NOT NULL | アップロード者ID（Usersテーブル参照） |
| UploadedAt | datetime2 | NOT NULL, DEFAULT: GETUTCDATE() | アップロード日時 |
| CreatedAt | datetime2 | NOT NULL, DEFAULT: GETUTCDATE() | 作成日時（UTC） |
| UpdatedAt | datetime2 | NOT NULL, DEFAULT: GETUTCDATE() | 更新日時（UTC） |

### インデックス

| インデックス名 | 対象カラム | 種類 | 説明 |
|----------------|-------------|------|------|
| IX_Attachments_IncidentId | IncidentId | NON-UNIQUE | インシデントでの検索高速化 |
| IX_Attachments_UploadedById | UploadedById | NON-UNIQUE | アップロード者での検索高速化 |

### 外部キー制約

| 制約名 | 参照先 | カラム | 削除ルール |
|---------|---------|--------|------------|
| FK_Attachments_Incidents_IncidentId | Incidents.Id | IncidentId | CASCADE |
| FK_Attachments_Users_UploadedById | Users.Id | UploadedById | RESTRICT |

### ビジネスルール

- インシデントが削除されると、関連する添付ファイルも自動的に削除されます
- ファイルサイズは0より大きい値である必要があります
- サポートされるファイル形式は画像、PDF、Word、Excel、テキストファイルです
- ファイル名とパスは空文字列であってはなりません

### 関連テーブル

- **Incident**: 関連インシデント（Incidentsテーブル、多対1）
- **UploadedBy**: アップロード者（Usersテーブル、多対1）

---

## AuditLogs

### テーブル概要
システム内での操作履歴を記録する監査ログテーブルです。データの変更履歴とユーザーの操作を追跡します。

### テーブル構造

| 項目名 | データ型 | 制約 | 説明 |
|--------|----------|------|------|
| Id | int | PRIMARY KEY, IDENTITY(1,1) | 主キー（自動採番） |
| UserId | int | NULL | 操作者ID（Usersテーブル参照） |
| Action | nvarchar(50) | NOT NULL | 操作種別（CREATE, UPDATE, DELETE, LOGIN, LOGOUT） |
| TableName | nvarchar(50) | NOT NULL | 操作対象テーブル名 |
| RecordId | int | NULL | 操作対象レコードID |
| OldValues | nvarchar(max) | NULL | 変更前の値（JSON形式） |
| NewValues | nvarchar(max) | NULL | 変更後の値（JSON形式） |
| IpAddress | nvarchar(45) | NULL | 操作者のIPアドレス |
| UserAgent | nvarchar(500) | NULL | 操作者のユーザーエージェント |
| IncidentId | int | NULL | 関連インシデントID（Incidentsテーブル参照） |
| CreatedAt | datetime2 | NOT NULL, DEFAULT: GETUTCDATE() | 作成日時（UTC） |
| UpdatedAt | datetime2 | NOT NULL, DEFAULT: GETUTCDATE() | 更新日時（UTC） |

### インデックス

| インデックス名 | 対象カラム | 種類 | 説明 |
|----------------|-------------|------|------|
| IX_AuditLogs_IncidentId | IncidentId | NON-UNIQUE | インシデントでの検索高速化 |
| IX_AuditLogs_UserId | UserId | NON-UNIQUE | ユーザーでの検索高速化 |

### 外部キー制約

| 制約名 | 参照先 | カラム | 削除ルール |
|---------|---------|--------|------------|
| FK_AuditLogs_Incidents_IncidentId | Incidents.Id | IncidentId | SET NULL |
| FK_AuditLogs_Users_UserId | Users.Id | UserId | SET NULL |

### ビジネスルール

- すべてのデータ変更操作（CREATE, UPDATE, DELETE）が記録されます
- ログイン・ログアウト操作も記録されます
- 変更前後の値はJSON形式で保存されます
- IPアドレスとユーザーエージェントはセキュリティ監査に使用されます
- インシデントが削除されても、関連する監査ログは保持されます

### 関連テーブル

- **User**: 操作者（Usersテーブル、多対1）
- **Incident**: 関連インシデント（Incidentsテーブル、多対1）

---

## Effectiveness

### テーブル概要
インシデント対応後の改善効果を測定・記録するテーブルです。改善前後の数値を比較し、効果を定量的に評価します。

### テーブル構造

| 項目名 | データ型 | 制約 | 説明 |
|--------|----------|------|------|
| Id | int | PRIMARY KEY, IDENTITY(1,1) | 主キー（自動採番） |
| IncidentId | int | NOT NULL | インシデントID（Incidentsテーブル参照） |
| EffectivenessType | nvarchar(50) | NOT NULL | 有効性測定タイプ（COST_REDUCTION, TIME_SAVING等） |
| **BeforeValue** | decimal(10,2) | NOT NULL | 改善前の値 |
| **AfterValue** | decimal(10,2) | NOT NULL | 改善後の値 |
| **ImprovementRate** | decimal(10,2) | NOT NULL | 改善率（%） |
| Description | nvarchar(500) | NOT NULL | 有効性の説明 |
| MeasuredById | int | NOT NULL | 測定者ID（Usersテーブル参照） |
| MeasuredAt | datetime2 | NOT NULL, DEFAULT: GETUTCDATE() | 測定日時 |
| CreatedAt | datetime2 | NOT NULL, DEFAULT: GETUTCDATE() | 作成日時（UTC） |
| UpdatedAt | datetime2 | NOT NULL, DEFAULT: GETUTCDATE() | 更新日時（UTC） |

**注**: 太字の項目は最新のエンティティクラスに追加された項目です。

### インデックス

| インデックス名 | 対象カラム | 種類 | 説明 |
|----------------|-------------|------|------|
| IX_Effectiveness_IncidentId | IncidentId | NON-UNIQUE | インシデントでの検索高速化 |
| IX_Effectiveness_MeasuredById | MeasuredById | NON-UNIQUE | 測定者での検索高速化 |

### 外部キー制約

| 制約名 | 参照先 | カラム | 削除ルール |
|---------|---------|--------|------------|
| FK_Effectiveness_Incidents_IncidentId | Incidents.Id | IncidentId | CASCADE |
| FK_Effectiveness_Users_MeasuredById | Users.Id | MeasuredById | RESTRICT |

### ビジネスルール

- 改善前後の値は0以上の値である必要があります
- 改善率は改善前後の値から自動計算されます
- 有効性測定タイプは事前定義されたカテゴリから選択されます
- インシデントが削除されると、関連する有効性測定も自動的に削除されます
- 測定者は必ず設定される必要があります

### 有効性測定タイプ

| タイプ | 説明 |
|--------|------|
| COST_REDUCTION | コスト削減 |
| TIME_SAVING | 時間短縮 |
| QUALITY_IMPROVEMENT | 品質向上 |
| CUSTOMER_SATISFACTION | 顧客満足度 |
| PRODUCTIVITY | 生産性向上 |
| SAFETY | 安全性向上 |
| ENVIRONMENTAL | 環境改善 |

### 関連テーブル

- **Incident**: 関連インシデント（Incidentsテーブル、多対1）
- **MeasuredBy**: 測定者（Usersテーブル、多対1）

---

## リレーションシップ図

```
Users (1) ←→ (多) Incidents
  ↑                    ↑
  |                    |
  |                    |
(多) ←→ (1)    (1) ←→ (多)
AuditLogs        Attachments

Users (1) ←→ (多) Effectiveness
  ↑                    ↑
  |                    |
  |                    |
(多) ←→ (1)    (1) ←→ (多)
Attachments      Incidents
```

## データ整合性ルール

### カスケード削除
- **Incidents** → **Attachments**: インシデント削除時、関連添付ファイルも削除
- **Incidents** → **Effectiveness**: インシデント削除時、関連有効性測定も削除

### 制限削除
- **Users** → **Incidents**: ユーザー削除時、関連インシデントがある場合は削除不可
- **Users** → **Attachments**: ユーザー削除時、関連添付ファイルがある場合は削除不可
- **Users** → **Effectiveness**: ユーザー削除時、関連有効性測定がある場合は削除不可

### NULL許可
- **Incidents.AssignedToId**: 担当者が未割り当ての場合
- **AuditLogs.UserId**: システム操作の場合
- **AuditLogs.IncidentId**: インシデント以外のテーブル操作の場合

## パフォーマンス考慮事項

### インデックス戦略
- 外部キーカラムには適切なインデックスを設定
- 検索頻度の高いカラム（Status, Priority, Category等）へのインデックス検討
- 複合インデックスの活用（例：Status + Priority + CreatedAt）

### データ型最適化
- 文字列フィールドには適切な長さ制限を設定
- 日時フィールドはdatetime2を使用して精度を確保
- 数値フィールドは用途に応じて適切な精度を選択

## セキュリティ考慮事項

### データ保護
- 機密情報（パスワード等）はハッシュ化して保存
- 個人情報の暗号化検討
- アクセスログの適切な管理

### 監査機能
- すべてのデータ変更の記録
- ユーザー操作の追跡
- セキュリティイベントの監視

## 今後の拡張性

### 予定されている機能
- 通知システムの実装
- レポート機能の強化
- モバイルアプリ対応
- API機能の拡張

### スケーラビリティ
- パーティショニング戦略の検討
- 読み取り専用レプリカの活用
- キャッシュ戦略の実装

---

**文書履歴**

| 日付 | バージョン | 変更内容 | 変更者 |
|------|------------|----------|--------|
| 2025-08-27 | 1.0 | 初版作成 | システム開発チーム |
